---
import Section from "../components/common/Section.astro";
import type { ArticleFrontmatter } from "../lib/types";
import {
  getShortDescription,
  processArticleDate,
  generateSourceUrl,
} from "../lib/utils";
import { GLOBAL } from "../lib/variables";
import type { MarkdownLayoutProps } from "astro";
import Prose from "../components/Prose.astro";
import Layout from "./Layout.astro";
import SubscribeCard from "../components/SubscribeCard.astro";
import ShareActions from "../components/ShareActions.astro";
import ArticleEngagement from "../components/ArticleEngagement.astro";
import RelatedArticles from "../components/RelatedArticles.astro";
import { getArticles } from "../lib/list";
import Breadcrumbs from "../components/common/Breadcrumbs.astro";

type Props = MarkdownLayoutProps<ArticleFrontmatter>;

const { frontmatter } = Astro.props;
const shortDescription = getShortDescription(frontmatter.description);
const articleDate = processArticleDate(frontmatter.timestamp);
const sourceUrl = generateSourceUrl(frontmatter.filename, "blog");
const currentArticlePath = `/blog/${frontmatter.filename}`;
const tagSet = new Set(Array.isArray(frontmatter.tags) ? frontmatter.tags : []);
const articles = await getArticles();
const breadcrumbs = [
  { label: "Home", url: "/" },
  { label: GLOBAL.articlesName, url: "/blog" },
  { label: frontmatter.title },
];

const scoredArticles = articles
  .filter((article) => article.filename !== currentArticlePath)
  .map((article) => {
    const overlap = article.tags
      ? article.tags.reduce(
          (count, tag) => (tagSet.has(tag) ? count + 1 : count),
          0,
        )
      : 0;
    return { article, overlap };
  })
  .sort((a, b) => {
    if (tagSet.size && a.overlap !== b.overlap) {
      return b.overlap - a.overlap;
    }
    const dateA = new Date(a.article.timestamp).getTime();
    const dateB = new Date(b.article.timestamp).getTime();
    return dateB - dateA;
  });

const prioritized = tagSet.size
  ? scoredArticles.filter(({ overlap }) => overlap > 0)
  : scoredArticles;
const fallback =
  tagSet.size && prioritized.length < 3
    ? scoredArticles.filter(({ overlap }) => overlap === 0)
    : [];
const relatedArticles = [...prioritized.slice(0, 3), ...fallback].slice(0, 3).map(({ article }) => article);
const resolveImageUrl = (value?: string) => {
  if (!value) return undefined;
  return value.startsWith("http") ? value : `${GLOBAL.rootUrl}/${value.replace(/^\/+/, "")}`;
};
const rawArticleImage =
  frontmatter.image ??
  frontmatter.cover ??
  frontmatter.hero ??
  frontmatter.socialImage;
const articleImage = resolveImageUrl(rawArticleImage) ?? `${GLOBAL.rootUrl}/${GLOBAL.profileImage}`;
const articleSchema = JSON.stringify(
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": frontmatter.title,
    "description": shortDescription,
    "datePublished": frontmatter.timestamp,
    "dateModified": frontmatter.timestamp,
    "author": {
      "@type": "Person",
      "name": GLOBAL.username,
      "url": GLOBAL.rootUrl,
    },
    "publisher": {
      "@type": "Organization",
      "name": GLOBAL.username,
      "logo": {
        "@type": "ImageObject",
        "url": `${GLOBAL.rootUrl}/${GLOBAL.profileImage}`,
      },
    },
    "image": articleImage,
    "mainEntityOfPage": sourceUrl,
    "url": frontmatter.url ?? sourceUrl,
    "keywords": Array.isArray(frontmatter.tags) ? frontmatter.tags : [],
  },
).replace(/</g, "\\u003c");
---

<Layout>
  <Fragment slot="head">
    <title>{frontmatter.title} • {GLOBAL.username}</title>
    <meta name="description" content={frontmatter.description} />
    <meta property="og:title" content={`${frontmatter.title} • ${GLOBAL.username}`} />
    <meta property="og:description" content={shortDescription} />
    <meta property="og:image" content={articleImage} />
    <meta property="og:url" content={frontmatter.url} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${frontmatter.title} • ${GLOBAL.username}`} />
    <meta name="twitter:description" content={shortDescription} />
    <meta name="twitter:image" content={articleImage} />
    <meta http-equiv="content-language" content="id" />
    <meta name="language" content="indonesia" />
    <link rel="canonical" href={sourceUrl} />
    <script type="application/ld+json" set:html={articleSchema}></script>
  </Fragment>
  <div
    class="reading-progress"
    data-reading-progress
    role="progressbar"
    aria-valuemin="0"
    aria-valuemax="100"
    aria-valuenow="0"
    aria-label="Progress membaca artikel"
  >
    <span></span>
    <div class="reading-progress__milestone" data-milestone="25">
      <span>25%</span>
    </div>
    <div class="reading-progress__milestone" data-milestone="50">
      <span>50%</span>
    </div>
    <div class="reading-progress__milestone" data-milestone="75">
      <span>75%</span>
    </div>
  </div>
  <div class="article-shell">
    <Section class="pt-8 article-section">
      <div class="max-w-prose w-full mx-auto lg:mx-0">
        <Breadcrumbs items={breadcrumbs} />
        <div class="flex flex-col gap-4 mt-8 mb-16 w-full">
          <h1
            class="text-3xl sm:text-4xl leading-tight font-display break-words"
          >
            {frontmatter.title}
          </h1>

          <div class="flex justify-between items-center text-sm w-full">
            <span class="whitespace-nowrap">{articleDate}</span>
            <span class="whitespace-nowrap">{frontmatter.time} min</span>
          </div>
        </div>

        <div
          class="article-main"
          data-article-body
          data-article-title={frontmatter.title}
          data-article-url={sourceUrl}
          data-article-slug={frontmatter.filename}
        >
          <Prose>
            <slot />
          </Prose>
        </div>

        <div class="my-12">
          <ShareActions title={frontmatter.title} url={frontmatter.url ?? sourceUrl} />
        </div>

        <div class="my-12">
          <ArticleEngagement slug={frontmatter.filename} title={frontmatter.title} />
        </div>

        {
          relatedArticles.length > 0 && (
            <div class="my-12">
              <RelatedArticles articles={relatedArticles} />
            </div>
          )
        }
      </div>
    </Section>
    <aside
      class="article-toc"
      data-toc-container
      data-visible="false"
      aria-label="Daftar isi artikel"
      hidden
    >
      <div class="article-toc__header">
        <div class="article-toc__title-wrap">
          <p class="article-toc__title">Daftar Isi</p>
          <span class="article-toc__icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
              <path d="M96 64C42.98 64 0 106.1 0 160v256c0 53 42.98 96 96 96h272c44.18 0 80-35.82 80-80V96c0-17.67-14.33-32-32-32H96zm320 368c0 17.64-14.36 32-32 32H96c-35.34 0-64-28.66-64-64s28.66-64 64-64h288v96zm0-128H96c-24.53 0-47.03 7.359-66.07 19.94C28.82 341.2 32 330.9 32 320V160c0-35.34 28.66-64 64-64h320v208z"/>
            </svg>
          </span>
        </div>
        <button
          type="button"
          class="article-toc__toggle"
          data-toc-toggle
          aria-expanded="true"
        >
          Sembunyikan
        </button>
      </div>
      <nav aria-label="Daftar isi" data-toc-body>
        <ol data-toc-list></ol>
      </nav>
    </aside>
  </div>

</Layout>

<script is:inline>
  (() => {
    if (typeof window === "undefined") return;
    const progressBarContainer = document.querySelector("[data-reading-progress]");
    const progressBar = progressBarContainer?.querySelector("span");
    const articleBody = document.querySelector("[data-article-body]");
    const tocContainer = document.querySelector("[data-toc-container]");
    const tocList = document.querySelector("[data-toc-list]");
    const tocToggle = tocContainer?.querySelector("[data-toc-toggle]");
    const tocBody = tocContainer?.querySelector("[data-toc-body]");
    const articleTitle = articleBody?.getAttribute("data-article-title") ?? document.title;
    const articleSourceUrl = articleBody?.getAttribute("data-article-url") ?? window.location.href;
    const articleSlug = articleBody?.getAttribute("data-article-slug") ?? "";
    if (articleSlug) {
      document.body.dataset.currentArticle = articleSlug;
    }

    const clamp = (value, min = 0, max = 1) => Math.min(Math.max(value, min), max);
    const slugify = (value = "") =>
      value
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-");

    const milestoneEls = progressBarContainer
      ? Array.from(progressBarContainer.querySelectorAll("[data-milestone]"))
      : [];
    const reminderKey = "ibedes:reading-reminder";

    const updateMilestones = (progress) => {
      milestoneEls.forEach((node) => {
        const value = Number(node.getAttribute("data-milestone")) / 100;
        node.dataset.active = progress >= value ? "true" : "false";
      });
    };

    const saveReminderProgress = (progress) => {
      if (!articleSlug) return;
      if (progress >= 0.95) {
        try {
          localStorage.removeItem(reminderKey);
        } catch (error) {
          console.warn("Gagal menghapus pengingat baca", error);
        }
        return;
      }
      try {
        const payload = {
          slug: articleSlug,
          title: articleTitle,
          url: articleSourceUrl,
          progress: Number((progress * 100).toFixed(0)),
          updatedAt: Date.now(),
        };
        localStorage.setItem(reminderKey, JSON.stringify(payload));
        window.dispatchEvent(new CustomEvent("ibedes:reading-reminder", { detail: payload }));
      } catch (error) {
        console.warn("Tidak dapat menyimpan progress baca", error);
      }
    };

    const updateProgress = () => {
      if (!progressBar || !articleBody) return;
      const articleRect = articleBody.getBoundingClientRect();
      const articleTop = window.scrollY + articleRect.top;
      const articleHeight = articleBody.scrollHeight;
      const viewportHeight = window.innerHeight;
      const maxScrollable = Math.max(articleHeight - viewportHeight, 0.00001);
      const progress = clamp((window.scrollY - articleTop) / maxScrollable);
      progressBar.style.transform = `scaleX(${progress})`;
      progressBar.setAttribute("aria-valuenow", (progress * 100).toFixed(0));
      updateMilestones(progress);
      saveReminderProgress(progress);
    };

    let ticking = false;
    const handleScroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateProgress();
          ticking = false;
        });
        ticking = true;
      }
    };

    window.addEventListener("scroll", handleScroll, { passive: true });
    window.addEventListener("resize", updateProgress);
    updateProgress();

    if (!articleBody) return;

    const setTocState = (collapsed) => {
      if (!tocContainer || !tocToggle) return;
      tocContainer.dataset.collapsed = collapsed ? "true" : "false";
      tocToggle.textContent = collapsed ? "Tampilkan" : "Sembunyikan";
      tocToggle.setAttribute("aria-expanded", collapsed ? "false" : "true");
    };

    const initializeTocState = () => {
      if (!tocContainer || !tocToggle) return;
      const prefersCollapsed = window.matchMedia("(max-width: 1023px)").matches;
      setTocState(prefersCollapsed);
    };

    tocToggle?.addEventListener("click", () => {
      if (!tocContainer) return;
      const collapsed = tocContainer.dataset.collapsed === "true";
      setTocState(!collapsed);
    });

    window.addEventListener("resize", () => {
      initializeTocState();
    });

    if (tocContainer && tocList) {
      const headingMap = {};
      const headings = Array.from(articleBody.querySelectorAll("h2, h3"));
      if (headings.length) {
        tocContainer.dataset.visible = "true";
        tocContainer.removeAttribute("hidden");
        headings.forEach((heading) => {
          const text = heading.textContent?.trim();
          if (!text) return;
          const baseSlug = slugify(text);
          headingMap[baseSlug] = (headingMap[baseSlug] ?? 0) + 1;
          const finalSlug = headingMap[baseSlug] > 1 ? `${baseSlug}-${headingMap[baseSlug]}` : baseSlug;
          if (!heading.id) heading.id = finalSlug;
          const item = document.createElement("li");
          item.dataset.level = heading.tagName.toLowerCase();
          const link = document.createElement("a");
          link.href = `#${finalSlug}`;
          link.textContent = text;
          item.appendChild(link);
          tocList.appendChild(item);
        });
        initializeTocState();
      }
    }

    const markerPattern = /^\s*\[!highlight\]\s*/i;
    const blockquotes = Array.from(articleBody.querySelectorAll("blockquote"));

    const writeToClipboard = (text) => {
      if (navigator.clipboard?.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise((resolve, reject) => {
        try {
          const helper = document.createElement("textarea");
          helper.value = text;
          helper.setAttribute("readonly", "");
          helper.style.position = "absolute";
          helper.style.left = "-9999px";
          document.body.appendChild(helper);
          helper.select();
          const success = document.execCommand("copy");
          document.body.removeChild(helper);
          if (success) resolve();
          else reject(new Error("Clipboard unavailable"));
        } catch (error) {
          reject(error);
        }
      });
    };

    const createActionButton = (label, iconPath) => {
      const button = document.createElement("button");
      button.type = "button";
      button.className = "quote-action";
      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="${iconPath}" />
        </svg>
        <span>${label}</span>
      `;
      button.dataset.defaultLabel = label;
      return button;
    };

    const updateButtonLabel = (button, text) => {
      const label = button.querySelector("span");
      if (label) label.textContent = text;
    };

    const flashState = (button, state, label) => {
      button.dataset.state = state;
      updateButtonLabel(button, label);
      setTimeout(() => {
        button.dataset.state = "idle";
        updateButtonLabel(button, button.dataset.defaultLabel ?? "");
      }, 1800);
    };

    blockquotes.forEach((blockquote, index) => {
      const firstParagraph = blockquote.querySelector("p");
      if (firstParagraph) {
        const paragraphHtml = firstParagraph.innerHTML;
        if (markerPattern.test(firstParagraph.textContent ?? "")) {
          firstParagraph.innerHTML = paragraphHtml.replace(markerPattern, "").trim();
          blockquote.classList.add("highlight-block");
        }
      }

      const quoteId = blockquote.id || `kutipan-${index + 1}`;
      blockquote.id = quoteId;

      const getQuoteText = () => {
        const clone = blockquote.cloneNode(true);
        clone.querySelectorAll(".quote-actions").forEach((node) => node.remove());
        return clone.textContent?.trim() ?? "";
      };

      const actions = document.createElement("div");
      actions.className = "quote-actions";

      const copyButton = createActionButton(
        "Salin",
        "M9 2H5a2 2 0 0 0-2 2v14h2V4h4zm10 4h-8a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2zm0 14h-8V8h8z",
      );
      copyButton.setAttribute("aria-label", "Salin kutipan");

      const shareButton = createActionButton(
        "Bagikan",
        "M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7m-5-4L12 5l-3 3m3-3v12",
      );
      shareButton.setAttribute("aria-label", "Bagikan kutipan");

      const handleCopy = async () => {
        const text = getQuoteText();
        if (!text) return;
        try {
          await writeToClipboard(text);
          flashState(copyButton, "success", "Disalin!");
        } catch (error) {
          flashState(copyButton, "error", "Gagal");
        }
      };

      const handleShare = async () => {
        const text = getQuoteText();
        if (!text) return;
        const shareUrl = `${articleSourceUrl}#${quoteId}`;
        if (navigator.share) {
          try {
            await navigator.share({
              title: articleTitle,
              text,
              url: shareUrl,
            });
            flashState(shareButton, "success", "Dibagikan!");
            return;
          } catch (error) {
            if (error?.name === "AbortError") return;
          }
        }
        try {
          await writeToClipboard(`${text} — ${articleTitle}\n${shareUrl}`);
          flashState(shareButton, "success", "Link siap!");
        } catch (error) {
          flashState(shareButton, "error", "Gagal");
        }
      };

      copyButton.addEventListener("click", handleCopy);
      shareButton.addEventListener("click", handleShare);
      actions.append(copyButton, shareButton);
      blockquote.appendChild(actions);
    });
  })();
</script>
