---
import Layout from "../../layouts/Layout.astro";
import Section from "../../components/common/Section.astro";
import ProductCard from "../../components/ProductCard.astro";
import { GLOBAL } from "../../lib/variables";
import { PRODUCTS } from "../../lib/products";

const hero = {
  title: "Rekomendasi Produk Terpercaya",
  description:
    "Kurasi alat belajar, gear kreator, sampai gadget santai yang benar-benar kupakai dan tested. Semua link affiliate yang ada di sini sudah terverifikasi dan aman.",
  sub: "Belanja lewat link ini bantu ibedes tetap konsisten nulis konten berkualitas.",
};

const categoryStats = PRODUCTS.reduce<Record<string, number>>((acc, product) => {
  acc[product.category] = (acc[product.category] ?? 0) + 1;
  return acc;
}, {});
const uniqueCategories = Object.keys(categoryStats);

const favoriteLabel = "Favorit";
const categories = ["Semua", ...uniqueCategories, favoriteLabel];

const kitProduct = PRODUCTS.find((product) => product.slug === "markaz-hunter-shopee-kit");

const supportSteps = [
  {
    title: "Pilih marketplace favorit",
    copy: "Klik marketplace yang paling nyaman. Harganya sama, cuma ada referensi untuk sedikit komisi.",
  },
  {
    title: "Checkout seperti biasa",
    copy: "Proses checkout normal, bandingkan harga, atau tunggu promo — selagi dari link ini, tetap support.",
  },
  {
    title: "Share experience",
    copy: "Ceritakan kalau sudah dipakai. Feedback kamu bantu aku pilih produk berikutnya yang lebih baik.",
  },
];

const tokopediaDropSlugs = [
  "soundcore-r50i-nc",
  "mirrorspace-3-wireless-case",
  "senter-led-zoom-90000",
];
const tokopediaDrops = PRODUCTS.filter((product) => tokopediaDropSlugs.includes(product.slug));

const toAbsoluteImage = (value?: string) => {
  if (!value) return undefined;
  return value.startsWith("http") ? value : `${GLOBAL.rootUrl}/${value.replace(/^\/+/, "")}`;
};

const structuredProducts = PRODUCTS.map((product) => {
  const primaryLink = product.links?.[0];
  const schemaProduct: Record<string, unknown> = {
    "@type": "Product",
    name: product.title,
    description: product.description,
    category: product.category,
    url: `${GLOBAL.rootUrl}/rekomendasi#${product.slug}`,
  };
  const absoluteImage = toAbsoluteImage(product.image);
  if (absoluteImage) {
    schemaProduct.image = absoluteImage;
  }
  if (product.tags?.length) {
    schemaProduct.keywords = product.tags.join(", ");
  }
  if (primaryLink) {
    schemaProduct.offers = {
      "@type": "Offer",
      url: primaryLink.url,
      priceCurrency: "IDR",
      availability: "https://schema.org/InStock",
    };
  }
  return schemaProduct;
});

const productListSchema = JSON.stringify(
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": `Kurasi Produk ${GLOBAL.username}`,
    "itemListElement": structuredProducts.map((product, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": product.url,
      "item": product,
    })),
  },
).replace(/</g, "\\u003c");
---

<Layout>
  <Fragment slot="head">
    <title>Rekomendasi Produk • {GLOBAL.username}</title>
    <meta
      name="description"
      content="Kurasi produk terpercaya dengan link affiliate Shopee dan Tokopedia. Alat belajar, gear kreator, dan gadget tested langsung oleh ibedes."
    />
    <meta property="og:title" content={`Rekomendasi Produk • ${GLOBAL.username}`} />
    <meta
      property="og:description"
      content="Kurasi produk terpercaya dengan link affiliate Shopee dan Tokopedia yang sudah tested."
    />
    <meta property="og:image" content={`${GLOBAL.rootUrl}/${GLOBAL.profileImage}`} />
    <meta property="og:url" content={`${GLOBAL.rootUrl}/rekomendasi`} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`Rekomendasi Produk • ${GLOBAL.username}`} />
    <meta
      name="twitter:description"
      content="Bantu ibedes tetap konsisten bikin konten berkualitas lewat kurasi produk terpercaya."
    />
    <meta name="twitter:image" content={`${GLOBAL.rootUrl}/${GLOBAL.profileImage}`} />
    <meta http-equiv="content-language" content="id" />
    <meta name="language" content="Indonesia" />
    <link rel="canonical" href={`${GLOBAL.rootUrl}/rekomendasi`} />
    <script type="application/ld+json" set:html={productListSchema}></script>
  </Fragment>

  <div class="max-w-5xl mx-auto mx-auto bg-slate-50 dark:bg-slate-900">
    <div class="max-w-5xl mx-auto text-center space-y-6 py-16 sm:py-24 px-4">
      <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/60 dark:bg-white/10 backdrop-blur-sm border border-white/80 dark:border-white/20 rounded-full shadow-sm">
        <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <span class="text-xs font-medium text-slate-700 dark:text-slate-300 tracking-wide">REKOMENDASI TERPERCAYA</span>
      </div>
      
      <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-slate-900 dark:text-white">
        {hero.title}
      </h1>
      
      <p class="text-sm sm:text-base lg:text-lg text-slate-600 dark:text-slate-400 max-w-4xl mx-auto leading-relaxed">
        {hero.description}
      </p>
      
      <div class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-50/80 dark:bg-emerald-900/30 backdrop-blur-sm border border-emerald-200/60 dark:border-emerald-500/40 rounded-lg shadow-sm">
        <svg class="w-4 h-4 text-emerald-600 dark:text-emerald-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        <span class="text-xs font-medium text-emerald-800 dark:text-emerald-200">{hero.sub}</span>
      </div>
    </div>
  </div>

  {kitProduct && (
    <div class="max-w-5xl mx-auto bg-white/50 dark:bg-slate-800/30">
      <div class="max-w-5xl mx-auto px-4 py-8 sm:py-12">
        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 sm:p-8 shadow-sm">
          <div class="flex flex-col lg:flex-row items-start gap-6">
            <div class="flex-1 space-y-4 max-w-5xl mx-auto">
              <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <span class="px-3 py-1 bg-slate-600 text-white text-xs font-medium rounded-full w-fit">
                  Kit Terbaru
                </span>
                <span class="text-sm text-slate-500 dark:text-slate-400">{kitProduct.title}</span>
              </div>
              
              <p class="text-sm sm:text-base text-slate-700 dark:text-slate-300 italic">
                {kitProduct.highlight}
              </p>
              
              <div class="space-y-3">
                {kitProduct.links.slice(0, 3).map((link) => (
                  <a
                    href={link.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-3 px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg hover:border-slate-300 dark:hover:border-slate-500 transition-colors"
                  >
                    <div class="flex items-center gap-2">
                      {link.label.toLowerCase().includes('shopee') && (
                        <img
                          src="/shopee-logo.svg"
                          alt="Shopee"
                          class="w-5 h-5 object-contain"
                          loading="lazy"
                        />
                      )}
                      {link.label.toLowerCase().includes('tokopedia') && (
                        <img
                          src="/tokopedia-logo.svg"
                          alt="Tokopedia"
                          class="w-5 h-5 object-contain"
                          loading="lazy"
                        />
                      )}
                      {link.label.toLowerCase().includes('tiktok') && (
                        <img
                          src="/tiktok-logo.svg"
                          alt="TikTok"
                          class="w-5 h-5 object-contain"
                          loading="lazy"
                        />
                      )}
                      <span class="font-medium text-sm">{link.label}</span>
                    </div>
                    <svg class="w-4 h-4 text-slate-400 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                  </a>
                ))}
              </div>
              
              <a
                href={`#${kitProduct.slug}`}
                class="inline-flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 font-medium transition-colors text-sm"
              >
                <span>Lihat detail kit lengkap</span>
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  )}

  {tokopediaDrops.length > 0 && (
    <div class="max-w-5xl mx-auto bg-slate-50/50 dark:bg-slate-800/20">
      <div class="max-w-5xl mx-auto py-12 sm:py-16 space-y-8 px-4">
        <div class="text-center space-y-4">
          <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/60 dark:bg-white/10 backdrop-blur-sm border border-white/80 dark:border-white/20 rounded-full shadow-sm">
            <svg class="w-4 h-4 text-emerald-600 dark:text-emerald-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
            </svg>
            <span class="text-xs font-medium text-slate-700 dark:text-slate-300 tracking-wide">TOKOPEDIA DROP</span>
          </div>
          
          <h2 class="text-xl sm:text-2xl lg:text-3xl font-bold text-slate-900 dark:text-white">
            Rilisan Terbaru
          </h2>
          
          <p class="text-sm sm:text-base text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
            Produk yang baru saja di-share di social media
          </p>
        </div>
        
        <div class="max-w-5xl mx-auto">
          <div class="grid gap-4 sm:gap-6 grid-cols-1">
            {tokopediaDrops.map((product) => (
              <a
                href={`#${product.slug}`}
                class="block bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6 hover:border-slate-300 dark:hover:border-slate-600 hover:shadow-md transition-all duration-200"
              >
                <div class="flex items-start justify-between">
                  <div class="flex-1 space-y-3">
                    <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                      <span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-200 text-xs font-medium rounded-full">
                        Tokopedia Drop
                      </span>
                      {product.tags?.slice(0, 2).map((tag) => (
                        <span class="text-xs text-slate-500 dark:text-slate-400">#{tag}</span>
                      ))}
                    </div>
                    
                    <h3 class="text-base sm:text-lg font-semibold text-slate-900 dark:text-white">
                      {product.title}
                    </h3>
                    
                    {product.highlight && (
                      <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400">
                        {product.highlight}
                      </p>
                    )}
                  </div>
                  
                  <svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 shrink-0 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>
  )}

  <div id="produk-terkurasi" class="max-w-5xl mx-auto py-16 sm:py-20">
    <div class="max-w-5xl mx-auto space-y-10 px-4">
      <div class="text-center space-y-4">
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-slate-900 dark:text-white">
          Semua Produk
        </h2>
        <p class="text-sm sm:text-base text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
          Filter berdasarkan kategori untuk kemudahan browsing
        </p>
      </div>
      
      <div class="flex flex-wrap justify-center gap-2 sm:gap-3 filter-scroll" data-filter-group data-favorite-label={favoriteLabel}>
        {categories.map((category, index) => (
          <button
            type="button"
            class:list={[
              "filter-chip px-3 py-2 sm:px-4 sm:py-2 rounded-lg font-medium text-xs sm:text-sm transition-colors",
              index === 0 ? "bg-slate-600 text-white" : "bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700",
            ]}
            data-filter-button
            data-filter-value={category}
            data-filter-favorite={category === favoriteLabel ? "true" : undefined}
          >
            <span>{category}</span>
            <span
              class="filter-chip__count ml-1 px-1.5 py-0.5 bg-black/10 dark:bg-white/20 rounded text-xs"
              data-filter-count={category === favoriteLabel ? "favorite" : undefined}
            >
              {category === "Semua" ? PRODUCTS.length : categoryStats[category] ?? 0}
            </span>
          </button>
        ))}
      </div>
      
      <div class="space-y-6">
        {PRODUCTS.map((product) => (
          <div
            data-product-wrapper
            data-category={product.category.toLowerCase()}
            data-product-slug={product.slug}
          >
            <ProductCard {...product} />
          </div>
        ))}
      </div>
    </div>
  </div>

  <div class="max-w-5xl mx-auto bg-slate-50/50 dark:bg-slate-800/20">
    <div class="max-w-5xl mx-auto py-16 sm:py-20 px-4">
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-8 sm:p-10 shadow-sm">
        <div class="text-center space-y-6">
          <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/60 dark:bg-white/10 backdrop-blur-sm border border-white/80 dark:border-white/20 rounded-full shadow-sm">
            <svg class="w-4 h-4 text-pink-600 dark:text-pink-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.74 0 3.41.99 4.22 2.51C11.09 4.99 12.76 4 14.5 4 17 4 19 6 19 8.5c0 3.78-3.4 6.86-8.55 11.54z"/>
            </svg>
            <span class="text-xs font-medium text-slate-700 dark:text-slate-300 tracking-wide">CARA KERJA AFFILIATE</span>
          </div>
          
          <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-slate-900 dark:text-white">
            Dukung Konten Berkualitas
          </h3>
          
          <p class="text-sm sm:text-base text-slate-600 dark:text-slate-400 max-w-2xl mx-auto leading-relaxed">
            Semua pembelian lewat link ini tercatat sebagai dukungan. Tidak ada biaya tambahan untukmu,
            tapi membantu aku tetap konsisten bikin konten yang berguna.
          </p>
          
          <div class="grid gap-4 sm:gap-6 md:grid-cols-3 mt-10">
            {supportSteps.map((step, index) => (
              <div class="bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl p-6 text-center space-y-4">
                <div class="inline-flex items-center justify-center w-8 h-8 bg-slate-600 text-white rounded-lg font-semibold text-sm">
                  {index + 1}
                </div>
                <h4 class="font-semibold text-slate-900 dark:text-white text-sm sm:text-base">
                  {step.title}
                </h4>
                <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                  {step.copy}
                </p>
              </div>
            ))}
          </div>
          
          <div class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-50/80 dark:bg-emerald-900/30 backdrop-blur-sm border border-emerald-200/60 dark:border-emerald-500/40 rounded-lg shadow-sm mt-6">
            <svg class="w-4 h-4 text-emerald-600 dark:text-emerald-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <span class="text-xs font-medium text-emerald-800 dark:text-emerald-200">
              Terima kasih sudah support!
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline>
  (() => {
    if (typeof window === "undefined") return;
    const buttons = Array.from(document.querySelectorAll("[data-filter-button]"));
    const wrappers = Array.from(document.querySelectorAll("[data-product-wrapper]"));
    if (!buttons.length || !wrappers.length) return;

    const favoriteLabel =
      document.querySelector("[data-filter-group]")?.getAttribute("data-favorite-label") ?? "Favorit";
    const filterStorageKey = "ibedes_rekomendasi_filter";
    const favoritesStorageKey = "ibedes_product_favorites";
    const favoriteCountNode = document.querySelector("[data-filter-count='favorite']");

    const parseJSON = (value) => {
      if (!value) return [];
      try {
        const parsed = JSON.parse(value);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    };

    const getFavorites = () => parseJSON(localStorage.getItem(favoritesStorageKey));

    const normalizeFilterValue = (value = "") => {
      const lower = value.trim().toLowerCase();
      if (!lower) return null;
      const match = buttons.find(
        (button) => (button.getAttribute("data-filter-value") ?? "").toLowerCase() === lower,
      );
      return match?.getAttribute("data-filter-value") ?? null;
    };

    const syncActiveButton = (value) => {
      buttons.forEach((button) => {
        const isActive = button.getAttribute("data-filter-value") === value;
        button.classList.toggle("is-active", isActive);
      });
    };

    const updateFavoriteCount = () => {
      if (!favoriteCountNode) return;
      const count = getFavorites().length;
      favoriteCountNode.textContent = count.toString();
    };

    let activeFilter = "Semua";

    const applyFilter = (value, options = {}) => {
      const resolved = normalizeFilterValue(value) ?? "Semua";
      activeFilter = resolved;
      syncActiveButton(resolved);

      const normalized = resolved.toLowerCase();
      const favorites = new Set(getFavorites());
      wrappers.forEach((wrapper) => {
        const category = (wrapper.getAttribute("data-category") ?? "").toLowerCase();
        const slug = wrapper.getAttribute("data-product-slug") ?? "";
        const isFavoriteFilter = normalized === favoriteLabel.toLowerCase();
        const visible =
          normalized === "semua" ||
          (isFavoriteFilter ? favorites.has(slug) : category === normalized);
        wrapper.style.display = visible ? "block" : "none";
      });

      if (options.updateState !== false) {
        try {
          localStorage.setItem(filterStorageKey, resolved);
        } catch (error) {
          console.warn("Gagal menyimpan filter", error);
        }
      }

      if (options.updateHistory !== false) {
        const params = new URLSearchParams(window.location.search);
        if (normalized === "semua") {
          params.delete("kategori");
        } else {
          params.set("kategori", normalized);
        }
        const query = params.toString();
        const newUrl = `${window.location.pathname}${query ? `?${query}` : ""}${window.location.hash}`;
        window.history.replaceState({}, "", newUrl);
      }
    };

    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        applyFilter(button.getAttribute("data-filter-value") ?? "Semua");
      });
    });

    const initialFilter =
      normalizeFilterValue(new URLSearchParams(window.location.search).get("kategori") ?? "") ??
      normalizeFilterValue(localStorage.getItem(filterStorageKey) ?? "") ??
      "Semua";

    applyFilter(initialFilter, { updateHistory: false, updateState: false });
    updateFavoriteCount();

    const handleFavoritesChange = () => {
      updateFavoriteCount();
      if (activeFilter.toLowerCase() === favoriteLabel.toLowerCase()) {
        applyFilter(favoriteLabel, { updateHistory: false, updateState: false });
      }
    };

    window.addEventListener("ibedes:favorites-changed", handleFavoritesChange);
    window.addEventListener("storage", (event) => {
      if (event.key === favoritesStorageKey) {
        handleFavoritesChange();
      }
      if (event.key === filterStorageKey && event.newValue) {
        applyFilter(event.newValue, { updateHistory: true, updateState: false });
      }
    });
  })();
</script>
