---
import Toast from "./Toast.astro";

interface Props {
  class?: string;
  enableInstallUI?: boolean;
}

const { class: className = "", enableInstallUI = true } = Astro.props;
---

<div class={`pwa-installer ${className}`} data-pwa-installer>
  <!-- Keep a single hidden Toast instance to include its CSS + JS API -->
  <Toast duration={0} />
</div>

<style>
  /* Uses Toast.astro for layout and mobile responsiveness. No extra styles needed here. */
</style>

<script define:vars={{ enableInstallUI }}>
  // PWA Installation and Update Manager (single Toast flow)
  class PWAInstaller {
    deferredPrompt: any = null;
    isInstalled: boolean = false;
    isUpdateAvailable: boolean = false;
    currentToast: any = null;
    SEEN_KEY = 'pwa_install_toast_seen';

    constructor() {
      this.init();
    }

    async init() {
      await this.registerServiceWorker();
      this.setupInstallPrompt();
      this.setupUpdatePrompt();
      this.checkIfInstalled();
      if (enableInstallUI) {
        this.checkInstallFallback();
      }
    }

    async registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js');
          console.log('Service Worker registered:', registration);

          registration.addEventListener('updatefound', () => {
            this.handleServiceWorkerUpdate(registration);
          });
        } catch (error) {
          console.log('Service Worker registration failed:', error);
        }
      }
    }

    handleServiceWorkerUpdate(registration: any) {
      const newWorker = registration.installing;
      if (newWorker) {
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            this.isUpdateAvailable = true;
            this.showUpdateToast();
          }
        });
      }
    }

    setupInstallPrompt() {
      if (!enableInstallUI) return;
      window.addEventListener('beforeinstallprompt', (e: any) => {
        e.preventDefault();
        this.deferredPrompt = e;
        this.showInstallToast();
      });
    }

    setupUpdatePrompt() {
      window.addEventListener('pwa-update-available', () => {
        this.isUpdateAvailable = true;
        this.showUpdateToast();
      });
    }

    checkIfInstalled() {
      if (window.matchMedia('(display-mode: standalone)').matches || (window.navigator as any).standalone) {
        this.isInstalled = true;
      }
    }

    checkInstallFallback() {
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobile && !this.isInstalled && !this.deferredPrompt && !this.hasSeenInstallToast()) {
        const showPromptOnInteraction = () => {
          document.removeEventListener('click', showPromptOnInteraction);
          document.removeEventListener('touchstart', showPromptOnInteraction);
          document.removeEventListener('scroll', showPromptOnInteraction);
          setTimeout(() => {
            if (!this.isInstalled && !this.deferredPrompt) this.showManualInstallToast();
          }, 10000);
        };
        document.addEventListener('click', showPromptOnInteraction, { once: true });
        document.addEventListener('touchstart', showPromptOnInteraction, { once: true });
        document.addEventListener('scroll', showPromptOnInteraction, { once: true });
      }
    }

    showInstallToast() {
      if (!enableInstallUI) return;
      if (this.isInstalled || this.hasSeenInstallToast()) return;
      this.showSingleToast({
        type: 'install',
        title: 'Install ibedes',
        message: 'Akses offline & notifikasi push',
        actionText: this.deferredPrompt ? 'Install' : 'Petunjuk Install',
        duration: 0,
        onAction: () => this.installApp(),
        onDismiss: () => {}
      });
      this.markInstallToastSeen();
    }

    showUpdateToast() {
      this.showSingleToast({
        type: 'update',
        title: 'Update Tersedia',
        message: 'Versi baru aplikasi siap diinstall',
        actionText: 'Update',
        duration: 0,
        onAction: () => this.updateApp(),
        onDismiss: () => { this.isUpdateAvailable = false; }
      });
    }

    showManualInstallToast() {
      if (!enableInstallUI) return;
      if (this.hasSeenInstallToast()) return;
      this.showSingleToast({
        type: 'info',
        title: 'Install Manual',
        message: 'Browser Anda tidak mendukung install otomatis. Gunakan menu browser untuk menambahkan ke layar utama.',
        actionText: 'Mengerti',
        duration: 0,
        onAction: () => this.dismissCurrentToast(),
        onDismiss: () => this.dismissCurrentToast()
      });
      this.markInstallToastSeen();
    }

    showSingleToast(options: any) {
      // Hide previously shown toast if any
      if (this.currentToast && window.Toast?.hide) {
        window.Toast.hide(this.currentToast);
      }
      const toast = window.Toast?.show ? window.Toast.show(options) : null;
      this.currentToast = toast;
      return toast;
    }

    dismissCurrentToast() {
      if (this.currentToast && window.Toast?.hide) {
        window.Toast.hide(this.currentToast);
        this.currentToast = null;
      }
    }

    hasSeenInstallToast() {
      try {
        return localStorage.getItem(this.SEEN_KEY) === '1';
      } catch (_) { return false; }
    }
    markInstallToastSeen() {
      try {
        localStorage.setItem(this.SEEN_KEY, '1');
      } catch (_) {}
    }

    async installApp() {
      if (this.deferredPrompt) {
        try {
          const result = await this.deferredPrompt.prompt();
          if (result.outcome === 'accepted') {
            console.log('PWA installed');
            this.isInstalled = true;
          }
        } catch (error) {
          console.log('Installation failed:', error);
        }
      } else {
        this.showManualInstallToast();
        return;
      }
      this.dismissCurrentToast();
    }

    async updateApp() {
      if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration && registration.waiting) {
          registration.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      }
      this.dismissCurrentToast();
      window.location.reload();
    }
  }

  if (typeof window !== 'undefined') {
    new PWAInstaller();
  }
</script>
