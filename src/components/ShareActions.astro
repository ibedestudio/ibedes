---
import { GLOBAL } from "../lib/variables";

export interface Props {
  title: string;
  url: string;
  class?: string;
}

const { title, url, class: className } = Astro.props;

const normalizeUrl = (rawUrl: string) => {
  if (!rawUrl) return GLOBAL.rootUrl;
  if (rawUrl.startsWith("http")) return rawUrl;
  if (rawUrl.startsWith("/")) return `${GLOBAL.rootUrl}${rawUrl}`;
  return `${GLOBAL.rootUrl}/${rawUrl}`;
};

const absoluteUrl = normalizeUrl(url);
const encodedUrl = encodeURIComponent(absoluteUrl);
const encodedTitle = encodeURIComponent(title);

const shareTargets = [
  {
    label: "WhatsApp",
    href: `https://wa.me/?text=${encodedTitle}%20${encodedUrl}`,
    aria: "Bagikan melalui WhatsApp",
  },
  {
    label: "X",
    href: `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`,
    aria: "Bagikan melalui X (Twitter)",
  },
  {
    label: "LinkedIn",
    href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
    aria: "Bagikan melalui LinkedIn",
  },
  {
    label: "Facebook",
    href: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
    aria: "Bagikan melalui Facebook",
  },
  {
    label: "Threads",
    href: `https://www.threads.net/intent/post?text=${encodedTitle}%20${encodedUrl}`,
    aria: "Bagikan melalui Threads",
  },
];

---

<section
  class:list={[
        "rounded-3xl border-2 border-black/70 dark:border-white/60 bg-white/70 dark:bg-zinc-900/70 p-6 flex flex-col gap-4",

    className,
  ]}
  data-share-section
  data-share-url={absoluteUrl}
  data-share-title={title}
  data-site-name={GLOBAL.username}
>
  <div class="flex flex-col gap-1">
    <p class="font-display text-xs uppercase tracking-[0.25em] zag-muted">
      Bagikan
    </p>
    <p class="text-xl">Biar temanmu juga ikut baca tulisan ini.</p>
  </div>

  <div class="flex flex-wrap gap-3">
    {
      shareTargets.map((target) => (
        <a
          href={target.href}
          target="_blank"
          rel="noopener noreferrer"
          class="px-4 py-2 rounded-2xl border-2 border-black/50 dark:border-white/50 font-mono text-xs uppercase tracking-[0.2em] zag-transition hover:-translate-y-0.5 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400"
          aria-label={target.aria}
        >
          {target.label}
        </a>
      ))
    }
    <button
      type="button"
      data-share-copy
      class="px-4 py-2 rounded-2xl border-2 border-dashed border-black/50 dark:border-white/50 font-mono text-xs uppercase tracking-[0.2em] zag-transition hover:-translate-y-0.5 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400"
    >
      Salin Link
    </button>
    <button
      type="button"
      data-web-share
      class="px-4 py-2 rounded-2xl border-2 border-black/70 dark:border-white/70 font-mono text-xs uppercase tracking-[0.2em] zag-transition hover:-translate-y-0.5 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400"
    >
      Share viaâ€¦
    </button>
    <button
      type="button"
      data-share-preview
      class="px-4 py-2 rounded-2xl border-2 border-emerald-500 font-mono text-xs uppercase tracking-[0.2em] text-emerald-700 dark:text-emerald-300 zag-transition hover:-translate-y-0.5 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400"
    >
      Preview Card
    </button>
  </div>

  <p
    data-copy-feedback
    class="text-xs font-mono uppercase tracking-[0.2em] text-emerald-700 dark:text-emerald-300 opacity-0 transition-opacity duration-300"
  >
    Link sudah tersalin!
  </p>

  <div class="share-preview" data-share-preview-panel hidden>
    <img
      data-share-preview-image
      alt="Social preview"
      class="share-preview__image"
    />
    <div class="share-preview__actions">
      <a
        data-share-preview-download
        href="#"
        class="share-preview__download"
        download="ibedes-preview.png"
      >
        Unduh PNG
      </a>
      <button type="button" data-share-preview-dismiss>Close</button>
    </div>
  </div>

  <script is:inline>
    (() => {
      if (typeof window === "undefined") return;
      const script = document.currentScript;
      const section = script?.closest?.("[data-share-section]");
      if (!section) return;
      const copyBtn = section.querySelector("[data-share-copy]");
      const feedback = section.querySelector("[data-copy-feedback]");
      const shareBtn = section.querySelector("[data-web-share]");
      const shareUrl = section.getAttribute("data-share-url") ?? window.location.href;
      const shareTitle = section.getAttribute("data-share-title") ?? document.title;
      const siteName = section.getAttribute("data-site-name") ?? "ibedes.xyz";
      const previewBtn = section.querySelector("[data-share-preview]");
      const previewPanel = section.querySelector("[data-share-preview-panel]");
      const previewImage = section.querySelector("[data-share-preview-image]");
      const previewDownload = section.querySelector("[data-share-preview-download]");
      const previewDismiss = section.querySelector("[data-share-preview-dismiss]");

      const showFeedback = () => {
        if (!feedback) return;
        feedback.setAttribute("data-visible", "true");
        feedback.style.opacity = "1";
        window.setTimeout(() => {
          feedback.style.opacity = "0";
          feedback.removeAttribute("data-visible");
        }, 2000);
      };

      copyBtn?.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(shareUrl);
          showFeedback();
        } catch (error) {
          console.error("Gagal menyalin tautan:", error);
        }
      });

      if (!("share" in navigator)) {
        shareBtn?.remove();
      } else {
        shareBtn?.addEventListener("click", async () => {
          try {
            await navigator.share({
              title: shareTitle,
              text: shareTitle,
              url: shareUrl,
            });
          } catch (error) {
            if (error?.name !== "AbortError") {
              console.error("Gagal membuka Web Share API:", error);
            }
          }
        });
      }

      const wrapText = (ctx, text, x, y, maxWidth, lineHeight) => {
        const words = text.split(" ");
        let line = "";
        let drawY = y;
        words.forEach((word, index) => {
          const testLine = `${line}${word} `;
          const metrics = ctx.measureText(testLine);
          if (metrics.width > maxWidth && index > 0) {
            ctx.fillText(line, x, drawY);
            line = `${word} `;
            drawY += lineHeight;
          } else {
            line = testLine;
          }
        });
        if (line) ctx.fillText(line.trim(), x, drawY);
        return drawY + lineHeight;
      };

      const generatePreview = () => {
        const canvas = document.createElement("canvas");
        canvas.width = 1200;
        canvas.height = 630;
        const ctx = canvas.getContext("2d");
        if (!ctx) return null;
        const gradient = ctx.createLinearGradient(0, 0, 1200, 630);
        gradient.addColorStop(0, "#0f172a");
        gradient.addColorStop(1, "#064e3b");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "rgba(255,255,255,0.15)";
        ctx.fillRect(60, 60, 1080, 510);

        ctx.fillStyle = "#ecfccb";
        ctx.font = "bold 60px 'IBM Plex Mono', monospace";
        ctx.textBaseline = "top";
        wrapText(ctx, shareTitle, 120, 150, 960, 70);

        ctx.fillStyle = "#d1fae5";
        ctx.font = "28px 'IBM Plex Mono', monospace";
        ctx.fillText(siteName, 120, 470);

        ctx.fillStyle = "#bbf7d0";
        ctx.font = "20px 'IBM Plex Mono', monospace";
        ctx.fillText(shareUrl.replace(/^https?:\/\//, ""), 120, 520);

        return canvas.toDataURL("image/png");
      };

      previewBtn?.addEventListener("click", () => {
        const dataUrl = generatePreview();
        if (!dataUrl || !previewImage || !previewPanel || !previewDownload) return;
        previewImage.src = dataUrl;
        previewPanel.hidden = false;
        previewDownload.href = dataUrl;
        previewDownload.download = `${siteName.toLowerCase().replace(/\s+/g, "-")}-preview.png`;
      });

      previewDismiss?.addEventListener("click", () => {
        if (previewPanel) {
          previewPanel.hidden = true;
        }
      });
    })();
  </script>
</section>
