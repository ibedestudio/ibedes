---
export interface Props {
  slug: string;
  title: string;
}

const { slug, title } = Astro.props;

const safeSlug = slug?.trim?.().replace(/^\/+|\/+$/g, "") || "artikel";

const seedLikes = Array.from(safeSlug)
  .map((char, index) => char.charCodeAt(0) * (index + 1))
  .reduce((acc, value) => acc + value, 0) %
  13 +
  3;

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL ?? "";
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY ?? "";
const supabaseEnabled = Boolean(supabaseUrl && supabaseAnonKey);
---

<section
  class="rounded-3xl border-2 border-black/70 dark:border-white/60 bg-white/80 dark:bg-zinc-900/70 p-6 flex flex-col gap-8"
  data-engagement
  data-slug={safeSlug}
  data-title={title}
  data-likes-seed={seedLikes}
  data-supabase-ready={supabaseEnabled ? "true" : "false"}
  data-supabase-url={supabaseEnabled ? supabaseUrl : undefined}
  data-supabase-key={supabaseEnabled ? supabaseAnonKey : undefined}
>
  <div class="flex flex-col gap-2">
    <p class="font-display text-xs uppercase tracking-[0.3em] zag-muted">interaksi</p>
    <h2 class="text-2xl">Terima kasih sudah membaca.</h2>
    <p class="text-sm text-zag-dark/70 dark:text-zag-light/80">
      Tinggalkan satu ❤️ atau komentar singkat untuk bantu kami memahami apa yang paling berkesan buatmu.
      {supabaseEnabled
        ? "Semua interaksi akan tersimpan aman di Supabase."
        : "Saat Supabase belum siap, interaksi akan disimpan sementara di browser kamu."}
    </p>
  </div>

  <div class="flex flex-wrap gap-4">
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-2xl border-2 border-black/70 dark:border-white/70 px-4 py-3 font-mono text-xs uppercase tracking-[0.2em] zag-transition hover:-translate-y-0.5 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 disabled:opacity-60"
      data-like-button
      aria-live="polite"
    >
      <span aria-hidden="true">❤️</span>
      <span class="font-semibold text-base" data-like-count>0</span>
      <span class="sr-only">total suka untuk artikel ini</span>
      <span class="font-mono text-[0.6rem] uppercase tracking-[0.3em]">Suka</span>
    </button>
    <p class="text-xs text-zag-dark/70 dark:text-zag-light/70">
      Kami menyaring spam secara otomatis dan bisa menghapus kiriman yang tidak relevan.
    </p>
  </div>

  <div class="flex flex-col gap-4 w-full">
    <div class="flex flex-col gap-2">
      <h3 class="font-display text-lg uppercase tracking-[0.2em]">Komentar</h3>
      <p class="text-sm text-zag-dark/80 dark:text-zag-light/80">
        Ceritakan satu hal yang kamu rasakan setelah membaca artikel ini.
      </p>
    </div>
    <p
      class="text-xs text-zag-dark/70 dark:text-zag-light/60"
      data-loading-state
    >
      Menyiapkan data interaksi...
    </p>
    <p
      class="text-sm font-mono uppercase tracking-[0.3em] text-emerald-700 dark:text-emerald-300 hidden"
      data-status-message
      aria-live="polite"
    ></p>
    <ul class="flex flex-col gap-4" data-comment-list></ul>
    <p
      class="text-sm text-zag-dark/70 dark:text-zag-light/70 italic"
      data-empty-comments
    >
      Belum ada komentar. Mulai duluan, yuk?
    </p>
    <form class="flex flex-col gap-4" data-comment-form>
      <label class="flex flex-col gap-1 text-sm">
        <span>Nama (opsional)</span>
        <input
          type="text"
          name="name"
          class="rounded-2xl border-2 border-black/40 dark:border-white/40 bg-transparent px-4 py-2 outline-none focus-visible:border-emerald-400"
          placeholder="Mis. Nadya, Teman Belajar"
          autocomplete="name"
        />
      </label>
      <label class="flex flex-col gap-1 text-sm">
        <span>Pesan</span>
        <textarea
          name="comment"
          class="rounded-2xl border-2 border-black/40 dark:border-white/40 bg-transparent px-4 py-2 outline-none focus-visible:border-emerald-400 min-h-[120px]"
          placeholder="Apa bagian favoritmu, atau apa yang ingin kamu coba setelah ini?"
          required
        ></textarea>
      </label>
      <button
        type="submit"
        class="self-start rounded-2xl border-2 border-black/70 dark:border-white/70 px-4 py-3 font-mono text-xs uppercase tracking-[0.3em] zag-transition hover:-translate-y-0.5 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 disabled:opacity-60"
      >
        Kirim Komentar
      </button>
    </form>
  </div>

  <script is:inline>
    (() => {
      if (typeof window === "undefined") return;

      const script = document.currentScript;
      const root = script?.closest?.("[data-engagement]");
      if (!root) return;

      const slug = root.getAttribute("data-slug") ?? "artikel";
      const likesSeed = Number(root.getAttribute("data-likes-seed")) || 0;
      const supabaseReady = root.getAttribute("data-supabase-ready") === "true";
      const supabaseUrl = root.getAttribute("data-supabase-url")?.replace(/\/+$/, "") ?? "";
      const supabaseKey = root.getAttribute("data-supabase-key") ?? "";
      const likeButton = root.querySelector("[data-like-button]");
      const likeCountEl = root.querySelector("[data-like-count]");
      const commentList = root.querySelector("[data-comment-list]");
      const emptyState = root.querySelector("[data-empty-comments]");
      const form = root.querySelector("[data-comment-form]");
      const nameInput = form?.querySelector?.("[name='name']");
      const commentInput = form?.querySelector?.("[name='comment']");
      const submitButton = form?.querySelector?.("button[type='submit']");
      const loadingState = root.querySelector("[data-loading-state]");
      const statusMessage = root.querySelector("[data-status-message]");

      const likesKey = `ibedes:likes:${slug}`;
      const commentsKey = `ibedes:comments:${slug}`;
      const useRemote = supabaseReady && Boolean(supabaseUrl && supabaseKey);

      const parseJSON = (value) => {
        try {
          return JSON.parse(value ?? "");
        } catch {
          return null;
        }
      };

      let likesState = parseJSON(window.localStorage.getItem(likesKey)) ?? {
        count: likesSeed,
        liked: false,
      };

      const setStatusMessage = (message = "", variant = "info") => {
        if (!statusMessage) return;
        if (!message) {
          statusMessage.hidden = true;
          statusMessage.textContent = "";
          statusMessage.style.color = "";
          return;
        }
        statusMessage.hidden = false;
        statusMessage.textContent = message;
        statusMessage.style.color =
          variant === "error"
            ? "rgb(220,38,38)"
            : "rgb(4,120,87)";
      };

      const setLoading = (state) => {
        if (!loadingState) return;
        loadingState.hidden = !state;
      };

      const updateLikeUI = () => {
        if (likeCountEl) {
          likeCountEl.textContent = `${likesState.count}`;
        }
        if (likeButton) {
          likeButton.disabled = likesState.liked;
          likeButton.setAttribute("aria-pressed", likesState.liked ? "true" : "false");
        }
      };

      const persistLikes = () => {
        window.localStorage.setItem(likesKey, JSON.stringify(likesState));
      };

      updateLikeUI();

      const renderEmptyState = () => {
        if (!emptyState) return;
        emptyState.hidden = Boolean(comments.length);
      };

      const sanitize = (value, fallback = "") => {
        if (typeof value !== "string") return fallback;
        return value.trim() || fallback;
      };

      const formatDate = (isoString) => {
        try {
          return new Intl.DateTimeFormat("id-ID", {
            dateStyle: "medium",
            timeStyle: "short",
          }).format(new Date(isoString));
        } catch {
          return isoString;
        }
      };

      const buildCommentItem = (comment) => {
        const li = document.createElement("li");
        li.dataset.commentId = comment.id;
        li.className =
          "flex flex-col gap-1 rounded-2xl border border-black/15 dark:border-white/20 bg-white/80 dark:bg-black/30 p-4";
        li.innerHTML = `
          <div class="flex items-center justify-between gap-4">
            <p class="font-semibold">${comment.name}</p>
            <span class="text-xs text-zag-dark/70 dark:text-zag-light/70">${formatDate(comment.createdAt)}</span>
          </div>
          <p class="text-sm leading-relaxed">${comment.message}</p>
        `;
        return li;
      };

      const loadComments = () => {
        const stored = parseJSON(window.localStorage.getItem(commentsKey));
        if (!Array.isArray(stored)) return [];
        return stored;
      };

      let comments = useRemote ? [] : loadComments();

      const renderComments = () => {
        if (!commentList) return;
        commentList.innerHTML = "";
        comments.forEach((comment) => {
          commentList.appendChild(buildCommentItem(comment));
        });
        renderEmptyState();
      };

      const persistComments = () => {
        if (useRemote) return;
        window.localStorage.setItem(commentsKey, JSON.stringify(comments.slice(0, 50)));
      };

      if (!useRemote) {
        renderComments();
        setLoading(false);
      }

      const supabaseHeaders = () => ({
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`,
        "Content-Type": "application/json",
      });

      const fetchLikeCount = async () => {
        if (!useRemote) return likesState.count;
        const params = new URLSearchParams({
          select: "id",
          slug: `eq.${slug}`,
        });
        const response = await fetch(
          `${supabaseUrl}/rest/v1/article_likes?${params.toString()}`,
          {
            headers: {
              ...supabaseHeaders(),
              Prefer: "count=exact",
            },
          },
        );
        if (!response.ok) {
          throw new Error("Gagal memuat data suka");
        }
        const range = response.headers.get("content-range");
        if (range && /\/(\d+)$/.test(range)) {
          const [, total] = range.match(/\/(\d+)$/) ?? [];
          return Number(total) || likesState.count;
        }
        const data = await response.json();
        return Array.isArray(data) ? data.length : likesState.count;
      };

      const fetchCommentsRemote = async () => {
        if (!useRemote) return comments;
        const params = new URLSearchParams({
          select: "id,name,message,created_at",
          slug: `eq.${slug}`,
          order: "created_at.desc",
          limit: "50",
        });
        const response = await fetch(
          `${supabaseUrl}/rest/v1/article_comments?${params.toString()}`,
          {
            headers: supabaseHeaders(),
          },
        );
        if (!response.ok) {
          throw new Error("Gagal memuat komentar");
        }
        const data = await response.json();
        if (!Array.isArray(data)) return [];
        return data.map((comment) => ({
          id: comment.id ?? crypto.randomUUID?.() ?? String(Date.now()),
          name: sanitize(comment.name, "Anonim"),
          message: sanitize(comment.message),
          createdAt: comment.created_at ?? new Date().toISOString(),
        }));
      };

      const bootstrap = async () => {
        if (!useRemote) return;
        try {
          setLoading(true);
          const [remoteLikes, remoteComments] = await Promise.all([
            fetchLikeCount(),
            fetchCommentsRemote(),
          ]);
          likesState.count = Number.isFinite(remoteLikes)
            ? remoteLikes
            : likesState.count;
          comments = remoteComments;
          persistLikes();
          renderComments();
          updateLikeUI();
          setStatusMessage("Data tersinkron dengan Supabase.");
        } catch (error) {
          console.error(error);
          setStatusMessage("Gagal memuat data Supabase. Menampilkan cadangan lokal.", "error");
          comments = loadComments();
          renderComments();
        } finally {
          setLoading(false);
        }
      };

      bootstrap();

      form?.addEventListener("submit", (event) => {
        event.preventDefault();
        const message = commentInput?.value?.trim();
        if (!message) {
          commentInput?.focus();
          return;
        }
        const name = nameInput?.value?.trim() || "Anonim";

        const submitLocalComment = (createdAt = new Date().toISOString()) => {
          const newComment = {
            id:
              typeof crypto !== "undefined" && crypto.randomUUID
                ? crypto.randomUUID()
                : `${Date.now()}-${Math.random().toString(16).slice(2)}`,
            name,
            message,
            createdAt,
          };
          comments = [newComment, ...comments].slice(0, 50);
          persistComments();
          renderComments();
          form.reset();
        };

        const sendToSupabase = async () => {
          if (!useRemote) {
            submitLocalComment();
            setStatusMessage("Komentar tersimpan di perangkatmu.");
            return;
          }
          submitButton?.setAttribute("disabled", "true");
          setStatusMessage("Mengirim komentar...");
          try {
            const response = await fetch(`${supabaseUrl}/rest/v1/article_comments`, {
              method: "POST",
              headers: {
                ...supabaseHeaders(),
                Prefer: "return=representation",
              },
              body: JSON.stringify({
                slug,
                name,
                message,
                status: "published",
              }),
            });
            if (!response.ok) {
              throw new Error("Komentar gagal dikirim");
            }
            const data = await response.json();
            const saved = Array.isArray(data) ? data[0] : null;
            submitLocalComment(saved?.created_at ?? new Date().toISOString());
            setStatusMessage("Komentar terkirim!");
          } catch (error) {
            console.error(error);
            submitLocalComment();
            setStatusMessage("Gagal ke Supabase, komentar disimpan lokal.", "error");
          } finally {
            submitButton?.removeAttribute("disabled");
          }
        };

        sendToSupabase();
      });

      const handleSupabaseLike = async () => {
        if (!useRemote) {
          likesState = {
            count: likesState.count + 1,
            liked: true,
          };
          persistLikes();
          updateLikeUI();
          return;
        }
        likeButton?.setAttribute("data-loading", "true");
        setStatusMessage("Mengirim suka...");
        try {
          const response = await fetch(`${supabaseUrl}/rest/v1/article_likes`, {
            method: "POST",
            headers: {
              ...supabaseHeaders(),
              Prefer: "return=minimal",
            },
            body: JSON.stringify({
              slug,
              user_hash: window.crypto?.randomUUID?.() ?? `${Date.now()}`,
            }),
          });
          if (!response.ok) {
            throw new Error("Gagal menambahkan suka");
          }
          likesState = {
            count: likesState.count + 1,
            liked: true,
          };
          persistLikes();
          updateLikeUI();
          setStatusMessage("Terima kasih sudah apresiasi!");
        } catch (error) {
          console.error(error);
          setStatusMessage("Suka gagal dikirim. Coba lagi.", "error");
        } finally {
          likeButton?.removeAttribute("data-loading");
        }
      };

      likeButton?.addEventListener("click", () => {
        if (likesState.liked) return;
        handleSupabaseLike();
      });

      if (useRemote) {
        window.addEventListener("online", () => {
          bootstrap();
        });
      }
    })();
  </script>
</section>
