---
import { GLOBAL } from "../lib/variables";

export interface Props {
  title: string;
  url: string;
  image?: string;
  class?: string;
}

const { title, url, image, class: className } = Astro.props;

const normalizeUrl = (rawUrl: string) => {
  if (!rawUrl) return GLOBAL.rootUrl;
  if (rawUrl.startsWith("http")) return rawUrl;
  if (rawUrl.startsWith("/")) return `${GLOBAL.rootUrl}${rawUrl}`;
  return `${GLOBAL.rootUrl}/${rawUrl}`;
};

const absoluteUrl = normalizeUrl(url);
const encodedUrl = encodeURIComponent(absoluteUrl);
const encodedTitle = encodeURIComponent(title);

const shareTargets = [
  {
    label: "WhatsApp",
    href: `https://wa.me/?text=${encodedTitle}%20${encodedUrl}`,
    aria: "Bagikan melalui WhatsApp",
    icon: "fa-brands fa-whatsapp",
  },
  {
    label: "X",
    href: `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`,
    aria: "Bagikan melalui X (Twitter)",
    icon: "fa-brands fa-x-twitter",
  },
  {
    label: "LinkedIn",
    href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
    aria: "Bagikan melalui LinkedIn",
    icon: "fa-brands fa-linkedin",
  },
  {
    label: "Facebook",
    href: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
    aria: "Bagikan melalui Facebook",
    icon: "fa-brands fa-facebook",
  },
  {
    label: "Threads",
    href: `https://www.threads.net/intent/post?text=${encodedTitle}%20${encodedUrl}`,
    aria: "Bagikan melalui Threads",
    icon: "fa-brands fa-threads",
  },
];
---

<section
  class:list={[
    "rounded-3xl border-2 border-black/70 dark:border-white/60 bg-white/70 dark:bg-zinc-900/70 p-6 flex flex-col gap-4",

    className,
  ]}
  data-share-section
  data-share-url={absoluteUrl}
  data-share-title={title}
  data-share-image-url={image}
>
  <div class="flex flex-col gap-1 mb-2">
    <p
      class="font-display text-xs uppercase tracking-[0.25em] zag-muted flex items-center gap-2"
    >
      <i class="fa-solid fa-share-nodes"></i>
      <span>Bagikan</span>
    </p>
    <p class="text-sm text-gray-600 dark:text-gray-400">
      Biar temanmu juga ikut baca tulisan ini.
    </p>
  </div>

  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
    {
      shareTargets.map((target) => (
        <a
          href={target.href}
          target="_blank"
          rel="noopener noreferrer"
          class="px-3 py-2 rounded-xl border border-black/10 dark:border-white/10 hover:border-emerald-500 dark:hover:border-emerald-400 bg-white/50 dark:bg-zinc-800/50 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 text-gray-700 dark:text-gray-300 font-mono text-[10px] sm:text-xs uppercase tracking-wider transition-all hover:-translate-y-0.5 flex items-center justify-center gap-2 group"
          aria-label={target.aria}
          data-share-platform={target.label.toLowerCase()}
        >
          <i
            class={`${target.icon} text-base group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors`}
          />
          <span class="truncate">{target.label}</span>
        </a>
      ))
    }
    <button
      type="button"
      data-share-copy
      class="px-3 py-2 rounded-xl border border-dashed border-black/30 dark:border-white/30 hover:border-emerald-500 dark:hover:border-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 text-gray-700 dark:text-gray-300 font-mono text-[10px] sm:text-xs uppercase tracking-wider transition-all hover:-translate-y-0.5 flex items-center justify-center gap-2 group"
    >
      <i
        class="fa-solid fa-link text-base group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors"
      ></i>
      <span>Salin</span>
    </button>
    <button
      type="button"
      data-web-share
      class="px-3 py-2 rounded-xl border border-black/10 dark:border-white/10 hover:border-emerald-500 dark:hover:border-emerald-400 bg-white/50 dark:bg-zinc-800/50 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 text-gray-700 dark:text-gray-300 font-mono text-[10px] sm:text-xs uppercase tracking-wider transition-all hover:-translate-y-0.5 flex items-center justify-center gap-2 group"
    >
      <i
        class="fa-solid fa-share-nodes text-base group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors"
      ></i>
      <span>More</span>
    </button>
    <button
      type="button"
      data-share-image
      class="px-3 py-2 rounded-xl border border-black/10 dark:border-white/10 hover:border-emerald-500 dark:hover:border-emerald-400 bg-white/50 dark:bg-zinc-800/50 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 text-gray-700 dark:text-gray-300 font-mono text-[10px] sm:text-xs uppercase tracking-wider transition-all hover:-translate-y-0.5 flex items-center justify-center gap-2 group sm:col-span-2 md:col-span-1"
    >
      <i
        class="fa-solid fa-image text-base group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors"
      ></i>
      <span>Image</span>
    </button>
  </div>

  <p
    data-copy-feedback
    class="text-xs font-mono uppercase tracking-[0.2em] text-emerald-700 dark:text-emerald-300 opacity-0 transition-opacity duration-300"
  >
    Link sudah tersalin!
  </p>

  <script is:inline>
    (() => {
      if (typeof window === "undefined") return;
      const script = document.currentScript;
      const section = script?.closest?.("[data-share-section]");
      if (!section) return;
      const copyBtn = section.querySelector("[data-share-copy]");
      const feedback = section.querySelector("[data-copy-feedback]");
      const shareBtn = section.querySelector("[data-web-share]");
      const shareImageBtn = section.querySelector("[data-share-image]");
      const shareLinks = section.querySelectorAll("[data-share-platform]");
      const shareUrl =
        section.getAttribute("data-share-url") ?? window.location.href;
      const shareTitle =
        section.getAttribute("data-share-title") ?? document.title;
      const shareImageUrl = section.getAttribute("data-share-image-url");

      const showFeedback = (message = "Link sudah tersalin!") => {
        if (!feedback) return;
        feedback.textContent = message;
        feedback.setAttribute("data-visible", "true");
        feedback.style.opacity = "1";
        window.setTimeout(() => {
          feedback.style.opacity = "0";
          feedback.removeAttribute("data-visible");
        }, 2000);
      };

      // Track share action
      const trackShare = (platform) => {
        if (typeof window.gtag === "function") {
          window.gtag("event", "share", {
            method: platform,
            content_type: "article",
            item_id: shareUrl,
          });
        }

        if (typeof window.trackShare === "function") {
          window.trackShare(platform, shareUrl, shareTitle);
        }
      };

      // Track social platform shares
      shareLinks.forEach((link) => {
        link.addEventListener("click", () => {
          const platform = link.getAttribute("data-share-platform");
          if (platform) {
            trackShare(platform);
          }
        });
      });

      copyBtn?.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(shareUrl);
          showFeedback("Link sudah tersalin!");
          trackShare("copy_link");
        } catch (error) {
          console.error("Gagal menyalin tautan:", error);
        }
      });

      if (!("share" in navigator)) {
        shareBtn?.remove();
      } else {
        shareBtn?.addEventListener("click", async () => {
          try {
            await navigator.share({
              title: shareTitle,
              text: shareTitle,
              url: shareUrl,
            });
            trackShare("web_share_api");
          } catch (error) {
            if (error?.name !== "AbortError") {
              console.error("Gagal membuka Web Share API:", error);
            }
          }
        });
      }

      // Share Image Logic
      if (shareImageBtn && shareImageUrl) {
        shareImageBtn.addEventListener("click", async () => {
          try {
            // Try to fetch the image to share it as a file
            const response = await fetch(shareImageUrl);
            const blob = await response.blob();
            const file = new File([blob], "share-image.png", {
              type: blob.type,
            });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: shareTitle,
                text: shareTitle,
                url: shareUrl,
              });
              trackShare("share_image_file");
            } else {
              throw new Error("Web Share API not supported for files");
            }
          } catch (error) {
            console.error("Failed to share image:", error);
            // Fallback: Copy Image URL
            try {
              await navigator.clipboard.writeText(shareImageUrl);
              if (typeof window.showToast === "function") {
                window.showToast("URL Gambar tersalin!", { type: "success" });
              } else {
                showFeedback("URL Gambar tersalin!");
              }
              trackShare("copy_image_url");
            } catch (clipboardError) {
              if (typeof window.showToast === "function") {
                window.showToast("Gagal membagikan gambar", { type: "error" });
              }
            }
          }
        });
      } else if (shareImageBtn) {
        shareImageBtn.remove();
      }
    })();
  </script>
</section>
