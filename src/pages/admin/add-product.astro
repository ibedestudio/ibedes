---
import Layout from "../../layouts/Layout.astro";
import { GLOBAL } from "../../lib/variables";
import { affiliateProducts } from "../../lib/affiliates";

// Extract unique values for suggestions
const existingIds = affiliateProducts.map((p) => p.id);
const uniqueCategories = [
    ...new Set(affiliateProducts.map((p) => p.category).filter(Boolean)),
];
const uniqueTags = [...new Set(affiliateProducts.flatMap((p) => p.tags || []))];

export const prerender = false;
---

<Layout title={`Add Affiliate Product - ${GLOBAL.username}`}>
    <div class="product-shell">
        <header class="product-header">
            <div>
                <p class="product-eyebrow">Produk afiliasi</p>
                <h1>Tambah produk baru</h1>
                <p>
                    Simpan detail produk, harga, dan tautan afiliasi dengan tata letak
                    yang lebih rapih.
                </p>
            </div>
            <div class="product-actions">
                <button
                    id="save-product-btn"
                    type="button"
                    class="product-button product-button--primary"
                >
                    <i class="fa-solid fa-save" aria-hidden="true"></i>
                    <span>Simpan produk</span>
                </button>
            </div>
        </header>

        <div class="product-grid">
            <section class="product-form">
                <article class="product-card">
                    <div class="product-card__head">
                        <div>
                            <p class="product-eyebrow">Identitas</p>
                            <h2>ID & nama produk</h2>
                        </div>
                    </div>
                    <div class="product-field-group">
                        <div class="product-field">
                            <label for="product-id">Product ID*</label>
                            <input
                                type="text"
                                id="product-id"
                                placeholder="jas-hujan-sp4"
                                required
                                class="product-input"
                                list="existing-ids"
                            />
                            <datalist id="existing-ids">
                                {existingIds.map((id) => <option value={id} />)}
                            </datalist>
                            <p class="product-hint">
                                Gunakan huruf kecil dan tanda hubung.
                            </p>
                        </div>
                        <div class="product-field">
                            <label for="product-name">Nama Produk*</label>
                            <input
                                type="text"
                                id="product-name"
                                placeholder="Jas Hujan Premium"
                                required
                                class="product-input"
                            />
                        </div>
                    </div>
                    <div class="product-field">
                        <label for="product-description">Deskripsi*</label>
                        <textarea
                            id="product-description"
                            rows="3"
                            placeholder="Deskripsi singkat"
                            required
                            class="product-textarea"
                        ></textarea>
                    </div>
                </article>

                <article class="product-card">
                    <div class="product-card__head">
                        <div>
                            <p class="product-eyebrow">Harga</p>
                            <h2>Detail penawaran</h2>
                        </div>
                    </div>
                    <div class="product-field-group">
                        <div class="product-field">
                            <label for="product-price">Harga</label>
                            <input
                                type="text"
                                id="product-price"
                                placeholder="Rp 80.000"
                                class="product-input"
                            />
                        </div>
                        <div class="product-field">
                            <label for="product-original-price">Harga awal</label>
                            <input
                                type="text"
                                id="product-original-price"
                                placeholder="Rp 100.000"
                                class="product-input"
                            />
                        </div>
                    </div>
                    <div class="product-field-group">
                        <div class="product-field">
                            <label for="product-discount">Diskon</label>
                            <input
                                type="text"
                                id="product-discount"
                                placeholder="20%"
                                class="product-input"
                            />
                        </div>
                        <div class="product-field">
                            <label for="product-rating">Rating</label>
                            <input
                                type="number"
                                id="product-rating"
                                placeholder="4.8"
                                min="0"
                                max="5"
                                step="0.1"
                                class="product-input"
                            />
                        </div>
                    </div>
                    <label class="product-check">
                        <input type="checkbox" id="product-verified" />
                        <span>Tandai sebagai produk terverifikasi</span>
                    </label>
                </article>

                <article class="product-card">
                    <div class="product-card__head">
                        <div>
                            <p class="product-eyebrow">Distribusi</p>
                            <h2>Platform & media</h2>
                        </div>
                    </div>
                    <div class="product-field">
                        <label for="product-platform">Platform*</label>
                        <select id="product-platform" required class="product-input">
                            <option value="shopee">Shopee</option>
                            <option value="tokopedia">Tokopedia</option>
                            <option value="lazada">Lazada</option>
                            <option value="blibli">Blibli</option>
                            <option value="tiktok">TikTok Shop</option>
                            <option value="amazon">Amazon</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="product-field">
                        <label for="product-image">Image URL*</label>
                        <input
                            type="url"
                            id="product-image"
                            placeholder="https://example.com/image.jpg"
                            required
                            class="product-input"
                        />
                    </div>
                    <div class="product-field">
                        <label for="product-link">Affiliate Link*</label>
                        <input
                            type="url"
                            id="product-link"
                            placeholder="https://affiliate-link.com"
                            required
                            class="product-input"
                        />
                    </div>
                </article>

                <article class="product-card">
                    <div class="product-card__head">
                        <div>
                            <p class="product-eyebrow">Klasifikasi</p>
                            <h2>Kategori & tag</h2>
                        </div>
                    </div>
                    <div class="product-field">
                        <label for="product-category">Kategori</label>
                        <input
                            type="text"
                            id="product-category"
                            placeholder="Productivity"
                            class="product-input"
                            list="categories-list"
                        />
                        <datalist id="categories-list">
                            {uniqueCategories.map((cat) => <option value={cat} />)}
                        </datalist>
                    </div>
                    <div class="product-field">
                        <label for="product-tags">Tags</label>
                        <input
                            type="text"
                            id="product-tags"
                            placeholder="outdoor, waterproof"
                            class="product-input"
                            list="tags-list"
                        />
                        <datalist id="tags-list">
                            {uniqueTags.map((tag) => <option value={tag} />)}
                        </datalist>
                        <p class="product-hint">
                            Pisahkan dengan koma.
                        </p>
                    </div>
                </article>
            </section>
        </div>

        <section class="product-existing">
            <div class="product-existing__head">
                <div>
                    <p class="product-eyebrow">Daftar produk</p>
                    <h2>Produk yang sudah tersimpan</h2>
                </div>
                <span class="product-pill">{affiliateProducts.length} items</span>
            </div>
            <div class="product-list" data-product-list>
                {affiliateProducts.length > 0 ? (
                    affiliateProducts.map((product) => (
                        <article class="product-item" data-product-card>
                            <div class="product-item__media">
                                <img src={product.image} alt={product.name} loading="lazy" />
                            </div>
                            <div class="product-item__body">
                                <p class="product-item__title">{product.name}</p>
                                <p class="product-item__meta">
                                    {product.category || "Uncategorized"}
                                </p>
                                <p class="product-item__price">
                                    {product.price || "-"}
                                    {product.discount && (
                                        <span class="product-item__discount">
                                            {product.discount}
                                        </span>
                                    )}
                                </p>
                                <p class="product-item__id">{product.id}</p>
                            </div>
                            <div class="product-item__actions">
                                <a
                                    href={`/admin/edit-product?id=${product.id}`}
                                    class="product-button product-button--ghost"
                                >
                                    <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                                    Edit
                                </a>
                                <button
                                    type="button"
                                    class="product-button product-button--danger"
                                    data-product-delete={product.id}
                                    data-product-name={product.name}
                                >
                                    <i class="fa-solid fa-trash" aria-hidden="true"></i>
                                    Hapus
                                </button>
                            </div>
                        </article>
                    ))
                ) : null}
            </div>
            <p
                class={`product-empty ${affiliateProducts.length ? "hidden" : ""}`}
                data-product-empty
            >
                Belum ada produk afiliasi tersimpan.
            </p>
        </section>
    </div>

    <script>
        const saveBtn = document.getElementById("save-product-btn");
        const priceInput = document.getElementById("product-price");
        const originalPriceInput = document.getElementById(
            "product-original-price",
        );
        const discountInput = document.getElementById("product-discount");
        const ratingInput = document.getElementById("product-rating");

        // Auto-calculate discount
        function calculateDiscount() {
            if (!priceInput || !originalPriceInput || !discountInput) return;

            const priceStr = priceInput.value.replace(/[^0-9]/g, "");
            const originalPriceStr = originalPriceInput.value.replace(
                /[^0-9]/g,
                "",
            );

            if (priceStr && originalPriceStr) {
                const price = parseInt(priceStr);
                const originalPrice = parseInt(originalPriceStr);

                if (originalPrice > price) {
                    const discount = Math.round(
                        ((originalPrice - price) / originalPrice) * 100,
                    );
                    discountInput.value = `${discount}%`;
                }
            }
        }

        priceInput?.addEventListener("input", calculateDiscount);
        originalPriceInput?.addEventListener("input", calculateDiscount);

        saveBtn?.addEventListener("click", async () => {
            const productId = document
                .getElementById("product-id")
                .value.trim();
            const productName = document
                .getElementById("product-name")
                .value.trim();
            const description = document
                .getElementById("product-description")
                .value.trim();
            const price = document.getElementById("product-price").value.trim();
            const originalPrice = document
                .getElementById("product-original-price")
                .value.trim();
            const discount = document
                .getElementById("product-discount")
                .value.trim();
            const platform = document.getElementById("product-platform").value;
            const image = document.getElementById("product-image").value.trim();
            const link = document.getElementById("product-link").value.trim();
            let categoryRaw = document
                .getElementById("product-category")
                .value.trim();
            const category = categoryRaw.split(",")[0].trim() || "General";
            const tagsRaw = document.getElementById("product-tags").value;
            const tags = [
                ...new Set(
                    tagsRaw
                        .split(",")
                        .map((t) => t.trim())
                        .filter((t) => t),
                ),
            ];
            const verified =
                document.getElementById("product-verified").checked;
            const rating = ratingInput?.value.trim();

            if (!productId || !productName || !description || !image || !link) {
                if (typeof window.showToast === "function") {
                    window.showToast("Please fill all required fields", {
                        type: "error",
                    });
                } else {
                    alert("Please fill all required fields");
                }
                return;
            }

            const product = {
                id: productId,
                name: productName,
                description,
                price: price || undefined,
                originalPrice: originalPrice || undefined,
                discount: discount || undefined,
                image,
                link,
                platform,
                category: category || "General",
                tags,
                rating: rating ? parseFloat(rating) : undefined,
                verified,
            };

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML =
                    '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';

                const response = await fetch("/api/admin/add-product", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(product),
                });

                const result = await response.json();

                if (response.ok) {
                    if (typeof window.showToast === "function") {
                        window.showToast("Product added successfully!", {
                            type: "success",
                        });
                    }

                    setTimeout(() => {
                        window.location.href = "/admin";
                    }, 1500);
                } else {
                    if (typeof window.showToast === "function") {
                        window.showToast("Error: " + result.error, {
                            type: "error",
                        });
                    } else {
                        alert("Error: " + result.error);
                    }
                    saveBtn.disabled = false;
                    saveBtn.innerHTML =
                        '<i class="fa-solid fa-save"></i> Simpan produk';
                }
            } catch (error) {
                console.error(error);
                if (typeof window.showToast === "function") {
                    window.showToast("Failed to save product", {
                        type: "error",
                    });
                } else {
                    alert("Failed to save product");
                }
                saveBtn.disabled = false;
                saveBtn.innerHTML =
                    '<i class="fa-solid fa-save"></i> Simpan produk';
            }
        });

        const productList = document.querySelector("[data-product-list]");
        const emptyState = document.querySelector("[data-product-empty]");

        function refreshEmptyState() {
            if (!productList || !emptyState) return;
            const hasItems = productList.querySelectorAll("[data-product-card]").length;
            if (hasItems) {
                emptyState.classList.add("hidden");
            } else {
                emptyState.classList.remove("hidden");
            }
        }

        productList?.addEventListener("click", async (event) => {
            const target = event.target as HTMLElement;
            const button = target.closest(
                "[data-product-delete]",
            ) as HTMLButtonElement | null;
            if (!button) return;

            const productId = button.dataset.productDelete;
            const productName = button.dataset.productName || productId;
            if (
                !productId ||
                !confirm(
                    `Hapus produk "${productName}"? Tindakan ini tidak bisa dibatalkan.`,
                )
            ) {
                return;
            }

            const card = button.closest("[data-product-card]");
            const originalContent = button.innerHTML;
            try {
                button.disabled = true;
                button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                const response = await fetch("/api/admin/delete-product", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ id: productId }),
                });

                const result = await response.json();

                if (response.ok) {
                    if (typeof window.showToast === "function") {
                        window.showToast("Produk dihapus", { type: "success" });
                    }
                    card?.classList.add("is-removing");
                    setTimeout(() => {
                        card?.remove();
                        refreshEmptyState();
                    }, 250);
                } else {
                    if (typeof window.showToast === "function") {
                        window.showToast(result.error || "Gagal menghapus", {
                            type: "error",
                        });
                    } else {
                        alert(result.error || "Failed to delete product");
                    }
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            } catch (error) {
                console.error(error);
                if (typeof window.showToast === "function") {
                    window.showToast("Terjadi kesalahan", { type: "error" });
                } else {
                    alert("Error deleting product");
                }
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        });
    </script>

    <style>
        .product-shell {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1.5rem 1.25rem 4rem;
            --product-border: 1px solid color-mix(
                in srgb,
                var(--color-foreground) 14%,
                transparent
            );
            --product-card-bg: color-mix(
                in srgb,
                var(--color-card) 92%,
                transparent
            );
            --product-radius: 1rem;
        }

        .product-header {
            border: var(--product-border);
            border-radius: var(--product-radius);
            background: var(--product-card-bg);
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .product-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
            }
        }

        .product-header h1 {
            font-family: var(--font-display);
            margin: 0;
            font-size: clamp(1.4rem, 3vw, 1.9rem);
        }

        .product-header p {
            margin: 0.35rem 0 0;
            max-width: 50ch;
            color: color-mix(in srgb, var(--color-foreground) 70%, transparent);
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .product-eyebrow {
            font-size: 0.7rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: color-mix(in srgb, var(--color-foreground) 55%, transparent);
            margin: 0 0 0.2rem 0;
        }

        .product-grid {
            margin-top: 1.5rem;
        }

        .product-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .product-card {
            border: var(--product-border);
            border-radius: var(--product-radius);
            background: var(--product-card-bg);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
        }

        .product-card__head h2 {
            margin: 0;
            font-size: 1.05rem;
        }

        .product-field-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .product-field {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .product-field label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
        }

        .product-input,
        .product-textarea,
        .product-field select {
            border: var(--product-border);
            border-radius: 0.8rem;
            background: transparent;
            padding: 0.65rem 0.9rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .product-textarea {
            min-height: 90px;
            resize: vertical;
        }

        .product-hint {
            font-size: 0.75rem;
            color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
        }

        .product-check {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.9rem;
        }

        .product-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            border-radius: 0.85rem;
            border: var(--product-border);
            padding: 0.55rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 150ms ease, border-color 150ms ease,
                background-color 150ms ease;
            background: transparent;
        }

        .product-button--primary {
            background: var(--color-primary);
            border-color: color-mix(in srgb, var(--color-primary) 60%, transparent);
            color: var(--color-background);
        }

        .product-button--ghost {
            background: color-mix(in srgb, var(--color-foreground) 6%, transparent);
        }

        .product-button--danger {
            border-color: color-mix(in srgb, crimson 40%, transparent);
            color: color-mix(in srgb, crimson 70%, transparent);
        }

        .product-button:hover,
        .product-button:focus-visible {
            transform: translateY(-1px);
        }

        .product-existing {
            margin-top: 2.5rem;
            border: var(--product-border);
            border-radius: var(--product-radius);
            background: var(--product-card-bg);
            padding: 1rem;
        }

        .product-existing__head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .product-pill {
            font-size: 0.8rem;
            padding: 0.15rem 0.65rem;
            border-radius: 999px;
            border: var(--product-border);
        }

        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 0.8rem;
        }

        .product-item {
            border: var(--product-border);
            border-radius: 0.9rem;
            padding: 0.8rem;
            display: flex;
            gap: 0.8rem;
            align-items: center;
            background: color-mix(in srgb, var(--color-background) 95%, transparent);
        }

        .product-item.is-removing {
            opacity: 0.4;
            transform: scale(0.98);
            transition: opacity 150ms ease, transform 150ms ease;
        }

        .product-item__media img {
            width: 64px;
            height: 64px;
            border-radius: 0.75rem;
            object-fit: cover;
            border: var(--product-border);
        }

        .product-item__body {
            flex: 1;
        }

        .product-item__title {
            margin: 0 0 0.15rem;
            font-weight: 600;
        }

        .product-item__meta,
        .product-item__id {
            margin: 0;
            font-size: 0.8rem;
            color: color-mix(in srgb, var(--color-foreground) 65%, transparent);
        }

        .product-item__price {
            margin: 0.15rem 0;
            font-family: var(--font-mono);
        }

        .product-item__discount {
            margin-left: 0.4rem;
            font-size: 0.75rem;
            color: color-mix(in srgb, crimson 70%, transparent);
        }

        .product-item__actions {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .product-empty {
            text-align: center;
            margin-top: 1rem;
            color: color-mix(in srgb, var(--color-foreground) 60%, transparent);
        }

        .hidden {
            display: none !important;
        }
    </style>
</Layout>
