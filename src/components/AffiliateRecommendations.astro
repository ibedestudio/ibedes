---
import type { AffiliateProduct } from "../lib/products";
import { PRODUCTS } from "../lib/products";

const {
  categories = [],
  maxItems = 2,
  title = "Rekomendasi Produk Terkait",
  description = "Dipilih khusus sesuai topik artikel ini. Belanja via link ini bantu ibedes terus bikin konten.",
} = Astro.props as {
  categories?: string[];
  maxItems?: number;
  title?: string;
  description?: string;
};

const normalizedCategories = Array.from(
  new Set(
    (categories ?? [])
      .map((category) => category?.toLowerCase?.().trim())
      .filter((category): category is string => Boolean(category)),
  ),
);

const primaryMatches = normalizedCategories.length
  ? PRODUCTS.filter((product) => normalizedCategories.includes(product.category.toLowerCase()))
  : [];

const backupMatches = normalizedCategories.length
  ? PRODUCTS.filter((product) =>
      product.tags?.some((tag) => normalizedCategories.includes(tag.toLowerCase())),
    )
  : [];

const recommendations: AffiliateProduct[] = (primaryMatches.length ? primaryMatches : backupMatches).slice(0, maxItems);
const hasRecommendations = recommendations.length > 0;
const blockId = `affiliate-inline-${Math.random().toString(36).slice(2, 9)}`;
---

{hasRecommendations && (
  <section
    id={blockId}
    data-affiliate-inline
    class="not-prose my-8"
  >
    <div class="rounded-3xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-5 sm:p-6 lg:p-8 shadow-sm">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between mb-6">
        <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-emerald-600 dark:text-emerald-400">Link Affiliate</p>
        <div>
          <h3 class="text-xl font-semibold text-slate-900 dark:text-white">{title}</h3>
          <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">{description}</p>
        </div>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        {recommendations.map((product) => {
          const primaryLink = product.links[0];
          return (
            <article
              class="flex flex-col overflow-hidden rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50/60 dark:bg-slate-800/40"
              data-category={product.category}
            >
              {product.image && (
                <div class="relative h-40 overflow-hidden">
                  <img
                    src={product.image}
                    alt={product.imageAlt ?? product.title}
                    loading="lazy"
                    decoding="async"
                    class="h-full w-full object-cover transition-transform duration-500 hover:scale-105"
                  />
                  {product.priceRange && (
                    <span class="absolute bottom-3 right-3 rounded-full border border-white/70 bg-white/90 px-2.5 py-1 text-xs font-semibold text-slate-700 shadow-sm">
                      {product.priceRange}
                    </span>
                  )}
                </div>
              )}

              <div class="flex flex-1 flex-col gap-2 px-4 pt-4 pb-3">
                <p class="text-[10px] uppercase tracking-[0.3em] text-slate-500">{product.category}</p>
                <h4 class="text-base font-semibold text-slate-900 dark:text-white leading-snug">{product.title}</h4>
                {product.highlight && (
                  <p class="text-xs text-emerald-700 dark:text-emerald-300 italic">{product.highlight}</p>
                )}
                <p class="text-sm text-slate-600 dark:text-slate-400">{product.description}</p>
              </div>

              {primaryLink && (
                <a
                  href={primaryLink.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="mt-auto flex items-center justify-between gap-2 px-4 py-3 text-sm font-semibold text-emerald-700 dark:text-emerald-300 border-t border-slate-200 dark:border-slate-700 hover:bg-white dark:hover:bg-slate-800 transition-colors"
                  data-affiliate-link
                  data-product={product.slug}
                  data-label={`Inline - ${primaryLink.label}`}
                >
                  <span>Cek Promo</span>
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="h-4 w-4">
                    <path d="M5 12h14m0 0-4-4m4 4-4 4" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" />
                  </svg>
                </a>
              )}
            </article>
          );
        })}
      </div>
    </div>
  </section>
)}

{hasRecommendations && (
  <script is:inline>
    {`
      (() => {
        if (typeof window === 'undefined') return;
        const block = document.getElementById('${blockId}');
        if (!block) return;
        const articleBody = document.querySelector('[data-article-body]');
        if (!articleBody) return;
        const paragraphs = Array.from(articleBody.querySelectorAll('p')).filter(
          (p) => !p.closest('[data-affiliate-inline]'),
        );
        const fallbackAnchors = Array.from(
          articleBody.querySelectorAll('h2, h3, h4, h5, h6, ul, ol, hr'),
        ).filter((node) => !node.closest('[data-affiliate-inline]'));
        const anchors = paragraphs.length ? paragraphs : fallbackAnchors;
        if (!anchors.length) return;
        const targetIndex = Math.max(1, Math.ceil(anchors.length / 2) - 1);
        const target = anchors[targetIndex] ?? anchors[anchors.length - 1];
        if (target?.parentNode) {
          target.parentNode.insertBefore(block, target.nextSibling);
        }
      })();
    `}
  </script>
)}
