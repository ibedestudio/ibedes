---
import Section from "../components/common/Section.astro";
import Breadcrumb from "../components/common/Breadcrumb.astro";
import type { ArticleFrontmatter } from "../lib/types";
import {
  getShortDescription,
  processArticleDate,
  generateSourceUrl,
} from "../lib/utils";
import { GLOBAL } from "../lib/variables";
import type { MarkdownLayoutProps } from "astro";
import Prose from "../components/Prose.astro";
import Layout from "./Layout.astro";
import SubscribeCard from "../components/SubscribeCard.astro";
import ShareActions from "../components/ShareActions.astro";
import FloatingReactions from "../components/FloatingReactions.astro";
import AffiliateProducts from "../components/AffiliateProducts.astro";
import ReadingProgress from "../components/ReadingProgress.astro";
import TextShareTooltip from "../components/TextShareTooltip.astro";
import {
  getAffiliateByArticle,
  getAffiliateProductsByIds,
} from "../lib/affiliates";
import { generateArticleSchema, generateSocialMeta } from "../lib/seo";
import TableOfContents from "../components/TableOfContents.astro";
import RelatedArticles from "../components/RelatedArticles.astro";
import CodeCopy from "../components/CodeCopy.astro";
import ImageLightbox from "../components/ImageLightbox.astro";
import BackToTop from "../components/BackToTop.astro";
import AuthorBio from "../components/AuthorBio.astro";

type Props = MarkdownLayoutProps<ArticleFrontmatter>;

const { frontmatter, headings } = Astro.props;
const shortDescription = getShortDescription(frontmatter.description);
const articleDate = processArticleDate(frontmatter.timestamp);
const sourceUrl = frontmatter.filename
  ? generateSourceUrl(frontmatter.filename, "blog")
  : "";

// Breadcrumb items
const breadcrumbItems = [
  { name: "Home", url: "/" },
  { name: "Blog", url: "/blog" },
  { name: frontmatter.title, url: frontmatter.url ?? sourceUrl },
];

// Generate Article structured data
const articleSchema = generateArticleSchema(
  {
    title: frontmatter.title,
    description: frontmatter.description,
    publishedTime: frontmatter.timestamp,
    author: GLOBAL.username,
    tags: frontmatter.tags,
    url: frontmatter.url ?? sourceUrl,
  },
  GLOBAL.rootUrl,
);

// Generate social meta tags with dynamic OG image
const ogImageUrl = frontmatter.filename
  ? `${GLOBAL.rootUrl}/og/${frontmatter.filename}.svg`
  : `${GLOBAL.rootUrl}/og/default.svg`;
const socialMeta = generateSocialMeta(
  frontmatter.title,
  frontmatter.description,
  ogImageUrl,
  `${GLOBAL.rootUrl}${frontmatter.url ?? sourceUrl}`,
  "article",
);

// Get affiliate products for this article
let affiliateProducts: any[] = [];

// Only check for affiliate mapping if filename exists
if (frontmatter.filename) {
  const articleAffiliate = getAffiliateByArticle(frontmatter.filename);
  if (articleAffiliate) {
    const mappedProducts = await getAffiliateProductsByIds(
      articleAffiliate.productIds,
    );
    affiliateProducts = [...affiliateProducts, ...mappedProducts];
  }
}

if (frontmatter.affiliateProducts && frontmatter.affiliateProducts.length > 0) {
  affiliateProducts = await getAffiliateProductsByIds(
    frontmatter.affiliateProducts,
  );
}

const affiliateContext = frontmatter.affiliateContext;
---

<Layout
  title={`${frontmatter.title} â€¢ ${GLOBAL.username}`}
  description={frontmatter.description}
  image={`${GLOBAL.rootUrl}/${GLOBAL.profileImage}`}
  type="article"
>
  <!-- Social Meta Tags in Head -->
  {
    Object.entries(socialMeta).map(([property, content]) => (
      <meta property={property} content={content} slot="head" />
    ))
  }

  <Section class="pt-8 !max-w-6xl">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_250px] gap-12 relative">
      <div class="w-full min-w-0">
        <div class="max-w-prose mx-auto lg:ml-auto lg:mr-0">
          <!-- Breadcrumb Navigation -->
          <Breadcrumb items={breadcrumbItems} />

          <div class="flex flex-col gap-4 mt-8 mb-8 w-full">
            <h1
              class="text-3xl sm:text-4xl leading-tight font-display break-words"
            >
              {frontmatter.title}
            </h1>

            <div
              class="flex justify-between items-center text-sm w-full text-muted-foreground font-mono"
            >
              <span class="whitespace-nowrap">
                {
                  processArticleDate(
                    frontmatter.pubDate || frontmatter.timestamp || new Date(),
                  )
                }
              </span>
              <span class="whitespace-nowrap">
                {frontmatter.minutesRead || frontmatter.time || "5 min"} read
              </span>
            </div>
          </div>

          {
            frontmatter.featuredImage && (
              <figure class="mb-10 w-full">
                <div class="rounded-xl overflow-hidden shadow-sm">
                  <img
                    src={frontmatter.featuredImage}
                    alt={frontmatter.featuredImageAlt || frontmatter.title}
                    class="w-full h-auto object-cover max-h-[500px]"
                  />
                </div>
                {frontmatter.featuredImageCaption && (
                  <figcaption class="mt-3 text-center text-sm text-muted-foreground italic font-mono">
                    <Fragment set:html={frontmatter.featuredImageCaption} />
                  </figcaption>
                )}
              </figure>
            )
          }

          <Prose id="article-content">
            <slot />
          </Prose>

          <RelatedArticles
            currentSlug={frontmatter.filename
              ? (frontmatter.filename.split("/").pop() ?? "")
              : ""}
            tags={frontmatter.tags ?? []}
          />

          <AuthorBio />

          <!-- Affiliate Products Section -->
          {
            affiliateProducts.length > 0 && (
              <div class="my-12">
                <AffiliateProducts
                  products={affiliateProducts}
                  context={affiliateContext}
                  title="Produk yang Mungkin Bantu"
                />
              </div>
            )
          }

          <div class="my-12">
            <ShareActions
              title={frontmatter.title}
              url={frontmatter.url ?? sourceUrl}
              image={ogImageUrl}
            />
          </div>

          <div class="my-12">
            <SubscribeCard />
          </div>
        </div>
      </div>

      <aside class="hidden lg:block relative">
        <div class="sticky top-24">
          <TableOfContents headings={headings} />
        </div>
      </aside>
    </div>
  </Section>

  <ReadingProgress />
  <TextShareTooltip
    title={frontmatter.title}
    url={frontmatter.url ?? sourceUrl}
  />
  <FloatingReactions
    slug={frontmatter.filename || "default"}
    title={frontmatter.title}
  />

  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <!-- Article-specific Analytics -->
  <script
    is:inline
    define:vars={{
      articleTitle: frontmatter.title,
      articleTags: frontmatter.tags?.join(",") || "",
      readingTime: frontmatter.time,
    }}
  >
    // Track article view
    if (typeof window !== "undefined") {
      window.addEventListener("load", () => {
        if (typeof window.trackPageView === "function") {
          window.trackPageView(window.location.pathname, document.title, {
            article_title: articleTitle,
            article_tags: articleTags,
            reading_time: readingTime,
          });
        }
      });
    }
  </script>
  <CodeCopy />
  <ImageLightbox />
  <BackToTop />
</Layout>
