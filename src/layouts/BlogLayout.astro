---
import Section from "../components/common/Section.astro";
import type { ArticleFrontmatter } from "../lib/types";
import {
  getShortDescription,
  processArticleDate,
  generateSourceUrl,
} from "../lib/utils";
import { GLOBAL } from "../lib/variables";
import type { MarkdownLayoutProps } from "astro";
import Prose from "../components/Prose.astro";
import Layout from "./Layout.astro";
import SubscribeCard from "../components/SubscribeCard.astro";
import ShareActions from "../components/ShareActions.astro";
import ArticleEngagement from "../components/ArticleEngagement.astro";
import RelatedArticles from "../components/RelatedArticles.astro";
import { getArticles } from "../lib/list";
import Breadcrumbs from "../components/common/Breadcrumbs.astro";

type Props = MarkdownLayoutProps<ArticleFrontmatter>;

const { frontmatter } = Astro.props;
const shortDescription = getShortDescription(frontmatter.description);
const articleDate = processArticleDate(frontmatter.timestamp);
const sourceUrl = generateSourceUrl(frontmatter.filename, "blog");
const currentArticlePath = `/blog/${frontmatter.filename}`;
const tagSet = new Set(Array.isArray(frontmatter.tags) ? frontmatter.tags : []);
const articles = await getArticles();
const breadcrumbs = [
  { label: "Home", url: "/" },
  { label: GLOBAL.articlesName, url: "/blog" },
  { label: frontmatter.title },
];

const scoredArticles = articles
  .filter((article) => article.filename !== currentArticlePath)
  .map((article) => {
    const overlap = article.tags
      ? article.tags.reduce(
          (count, tag) => (tagSet.has(tag) ? count + 1 : count),
          0,
        )
      : 0;
    return { article, overlap };
  })
  .sort((a, b) => {
    if (tagSet.size && a.overlap !== b.overlap) {
      return b.overlap - a.overlap;
    }
    const dateA = new Date(a.article.timestamp).getTime();
    const dateB = new Date(b.article.timestamp).getTime();
    return dateB - dateA;
  });

const prioritized = tagSet.size
  ? scoredArticles.filter(({ overlap }) => overlap > 0)
  : scoredArticles;
const fallback =
  tagSet.size && prioritized.length < 3
    ? scoredArticles.filter(({ overlap }) => overlap === 0)
    : [];
const relatedArticles = [...prioritized.slice(0, 3), ...fallback].slice(0, 3).map(({ article }) => article);
const resolveImageUrl = (value?: string) => {
  if (!value) return undefined;
  return value.startsWith("http") ? value : `${GLOBAL.rootUrl}/${value.replace(/^\/+/, "")}`;
};
const rawArticleImage =
  frontmatter.image ??
  frontmatter.cover ??
  frontmatter.hero ??
  frontmatter.socialImage;
const articleImage = resolveImageUrl(rawArticleImage) ?? `${GLOBAL.rootUrl}/${GLOBAL.profileImage}`;
const articleSchema = JSON.stringify(
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": frontmatter.title,
    "description": shortDescription,
    "datePublished": frontmatter.timestamp,
    "dateModified": frontmatter.timestamp,
    "author": {
      "@type": "Person",
      "name": GLOBAL.username,
      "url": GLOBAL.rootUrl,
    },
    "publisher": {
      "@type": "Organization",
      "name": GLOBAL.username,
      "logo": {
        "@type": "ImageObject",
        "url": `${GLOBAL.rootUrl}/${GLOBAL.profileImage}`,
      },
    },
    "image": articleImage,
    "mainEntityOfPage": sourceUrl,
    "url": frontmatter.url ?? sourceUrl,
    "keywords": Array.isArray(frontmatter.tags) ? frontmatter.tags : [],
  },
).replace(/</g, "\\u003c");
---

<Layout>
  <Fragment slot="head">
    <title>{frontmatter.title} • {GLOBAL.username}</title>
    <meta name="description" content={frontmatter.description} />
    <meta property="og:title" content={`${frontmatter.title} • ${GLOBAL.username}`} />
    <meta property="og:description" content={shortDescription} />
    <meta property="og:image" content={articleImage} />
    <meta property="og:url" content={frontmatter.url} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${frontmatter.title} • ${GLOBAL.username}`} />
    <meta name="twitter:description" content={shortDescription} />
    <meta name="twitter:image" content={articleImage} />
    <meta http-equiv="content-language" content="id" />
    <meta name="language" content="indonesia" />
    <link rel="canonical" href={sourceUrl} />
    <script type="application/ld+json" set:html={articleSchema}></script>
  </Fragment>
  <div
    class="reading-progress"
    data-reading-progress
    role="progressbar"
    aria-valuemin="0"
    aria-valuemax="100"
    aria-valuenow="0"
    aria-label="Progress membaca artikel"
  >
    <span></span>
    <div class="reading-progress__milestone" data-milestone="25">
      <span>25%</span>
    </div>
    <div class="reading-progress__milestone" data-milestone="50">
      <span>50%</span>
    </div>
    <div class="reading-progress__milestone" data-milestone="75">
      <span>75%</span>
    </div>
  </div>
  <div class="article-shell">
    <Section class="pt-8 article-section">
      <div class="max-w-prose w-full mx-auto lg:mx-0">
        <Breadcrumbs items={breadcrumbs} />
        <div class="flex flex-col gap-4 mt-8 mb-16 w-full">
          <h1
            class="text-3xl sm:text-4xl leading-tight font-display break-words"
          >
            {frontmatter.title}
          </h1>

          <div class="flex justify-between items-center text-sm w-full">
            <span class="whitespace-nowrap">{articleDate}</span>
            <span class="whitespace-nowrap">{frontmatter.time} min</span>
          </div>
        </div>

        <div
          class="article-main"
          data-article-body
          data-article-title={frontmatter.title}
          data-article-url={sourceUrl}
        >
          <Prose>
            <slot />
          </Prose>
        </div>

        <div class="my-12">
          <ShareActions title={frontmatter.title} url={frontmatter.url ?? sourceUrl} />
        </div>

        <div class="my-12">
          <ArticleEngagement slug={frontmatter.filename} title={frontmatter.title} />
        </div>

        {
          relatedArticles.length > 0 && (
            <div class="my-12">
              <RelatedArticles articles={relatedArticles} />
            </div>
          )
        }
      </div>
    </Section>
  </div>

  <div
    class="selection-share"
    data-selection-share
    hidden
    aria-hidden="true"
  >
    <div class="selection-share__actions">
      <button
        type="button"
        class="selection-share__button"
        data-selection-copy
        data-default-label="Salin"
        aria-label="Salin teks yang dipilih"
      >
        <i class="fa-regular fa-copy" aria-hidden="true"></i>
        <span>Salin</span>
      </button>
      <button
        type="button"
        class="selection-share__button selection-share__button--accent"
        data-selection-share-action
        data-default-label="Bagikan"
        aria-label="Bagikan teks yang dipilih"
      >
        <i class="fa-solid fa-share-nodes" aria-hidden="true"></i>
        <span>Bagikan</span>
      </button>
    </div>
  </div>

</Layout>

<script is:inline>
  (() => {
    if (typeof window === "undefined") return;
    const progressBarContainer = document.querySelector("[data-reading-progress]");
    const progressBar = progressBarContainer?.querySelector("span");
    const articleBody = document.querySelector("[data-article-body]");
    const articleTitle = articleBody?.getAttribute("data-article-title") ?? document.title;
    const articleSourceUrl = articleBody?.getAttribute("data-article-url") ?? window.location.href;

    const clamp = (value, min = 0, max = 1) => Math.min(Math.max(value, min), max);

    const milestoneEls = progressBarContainer
      ? Array.from(progressBarContainer.querySelectorAll("[data-milestone]"))
      : [];

    const updateMilestones = (progress) => {
      milestoneEls.forEach((node) => {
        const value = Number(node.getAttribute("data-milestone")) / 100;
        node.dataset.active = progress >= value ? "true" : "false";
      });
    };

    const updateProgress = () => {
      if (!progressBar || !articleBody) return;
      const articleRect = articleBody.getBoundingClientRect();
      const articleTop = window.scrollY + articleRect.top;
      const articleHeight = articleBody.scrollHeight;
      const viewportHeight = window.innerHeight;
      const maxScrollable = Math.max(articleHeight - viewportHeight, 0.00001);
      const progress = clamp((window.scrollY - articleTop) / maxScrollable);
      progressBar.style.transform = `scaleX(${progress})`;
      progressBar.setAttribute("aria-valuenow", (progress * 100).toFixed(0));
      updateMilestones(progress);
    };

    let ticking = false;
    const handleScroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateProgress();
          ticking = false;
        });
        ticking = true;
      }
    };

    window.addEventListener("scroll", handleScroll, { passive: true });
    window.addEventListener("resize", updateProgress);
    updateProgress();

    if (!articleBody) return;

    const markerPattern = /^\s*\[!highlight\]\s*/i;
    const blockquotes = Array.from(articleBody.querySelectorAll("blockquote"));

    const writeToClipboard = (text) => {
      if (navigator.clipboard?.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise((resolve, reject) => {
        try {
          const helper = document.createElement("textarea");
          helper.value = text;
          helper.setAttribute("readonly", "");
          helper.style.position = "absolute";
          helper.style.left = "-9999px";
          document.body.appendChild(helper);
          helper.select();
          const success = document.execCommand("copy");
          document.body.removeChild(helper);
          if (success) resolve();
          else reject(new Error("Clipboard unavailable"));
        } catch (error) {
          reject(error);
        }
      });
    };

    const createActionButton = (label, iconPath) => {
      const button = document.createElement("button");
      button.type = "button";
      button.className = "quote-action";
      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="${iconPath}" />
        </svg>
        <span>${label}</span>
      `;
      button.dataset.defaultLabel = label;
      return button;
    };

    const updateButtonLabel = (button, text) => {
      const label = button.querySelector("span");
      if (label) label.textContent = text;
    };

    const flashState = (button, state, label) => {
      button.dataset.state = state;
      updateButtonLabel(button, label);
      setTimeout(() => {
        button.dataset.state = "idle";
        updateButtonLabel(button, button.dataset.defaultLabel ?? "");
      }, 1800);
    };

    blockquotes.forEach((blockquote, index) => {
      const firstParagraph = blockquote.querySelector("p");
      if (firstParagraph) {
        const paragraphHtml = firstParagraph.innerHTML;
        if (markerPattern.test(firstParagraph.textContent ?? "")) {
          firstParagraph.innerHTML = paragraphHtml.replace(markerPattern, "").trim();
          blockquote.classList.add("highlight-block");
        }
      }

      const quoteId = blockquote.id || `kutipan-${index + 1}`;
      blockquote.id = quoteId;

      const getQuoteText = () => {
        const clone = blockquote.cloneNode(true);
        clone.querySelectorAll(".quote-actions").forEach((node) => node.remove());
        return clone.textContent?.trim() ?? "";
      };

      const actions = document.createElement("div");
      actions.className = "quote-actions";

      const copyButton = createActionButton(
        "Salin",
        "M9 2H5a2 2 0 0 0-2 2v14h2V4h4zm10 4h-8a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2zm0 14h-8V8h8z",
      );
      copyButton.setAttribute("aria-label", "Salin kutipan");

      const shareButton = createActionButton(
        "Bagikan",
        "M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7m-5-4L12 5l-3 3m3-3v12",
      );
      shareButton.setAttribute("aria-label", "Bagikan kutipan");

      const handleCopy = async () => {
        const text = getQuoteText();
        if (!text) return;
        try {
          await writeToClipboard(text);
          flashState(copyButton, "success", "Disalin!");
        } catch (error) {
          flashState(copyButton, "error", "Gagal");
        }
      };

      const handleShare = async () => {
        const text = getQuoteText();
        if (!text) return;
        const shareUrl = `${articleSourceUrl}#${quoteId}`;
        if (navigator.share) {
          try {
            await navigator.share({
              title: articleTitle,
              text,
              url: shareUrl,
            });
            flashState(shareButton, "success", "Dibagikan!");
            return;
          } catch (error) {
            if (error?.name === "AbortError") return;
          }
        }
        try {
          await writeToClipboard(`${text} — ${articleTitle}\n${shareUrl}`);
          flashState(shareButton, "success", "Link siap!");
        } catch (error) {
          flashState(shareButton, "error", "Gagal");
        }
      };

      copyButton.addEventListener("click", handleCopy);
      shareButton.addEventListener("click", handleShare);
      actions.append(copyButton, shareButton);
      blockquote.appendChild(actions);
    });

    const selectionPopover = document.querySelector("[data-selection-share]");
    const selectionCopyBtn = selectionPopover?.querySelector("[data-selection-copy]");
    const selectionShareBtn = selectionPopover?.querySelector("[data-selection-share-action]");
    const MIN_SELECTION_LENGTH = 20;
    let currentSelectionText = "";

    const hideSelectionPopover = () => {
      if (!selectionPopover) return;
      selectionPopover.hidden = true;
      selectionPopover.removeAttribute("data-visible");
    };

    const positionSelectionPopover = (rect) => {
      if (!selectionPopover) return;
      const scrollX = window.scrollX || document.documentElement.scrollLeft || 0;
      const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
      const top = scrollY + rect.top - 12;
      const centerX = scrollX + rect.left + rect.width / 2;
      selectionPopover.style.setProperty("--selection-share-left", `${centerX}px`);
      selectionPopover.style.setProperty("--selection-share-top", `${top}px`);
      selectionPopover.hidden = false;
      selectionPopover.setAttribute("data-visible", "true");
    };

    const getSelectionRect = (selection) => {
      if (!selection || selection.rangeCount === 0) return null;
      try {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        if (rect && (rect.width || rect.height)) return rect;
        const clientRects = range.getClientRects();
        return clientRects.length ? clientRects[0] : null;
      } catch {
        return null;
      }
    };

    const handleSelectionChange = () => {
      if (!selectionPopover) return;
      const selection = window.getSelection();
      if (!selection || selection.isCollapsed) {
        hideSelectionPopover();
        return;
      }
      const text = selection.toString().trim();
      if (text.length < MIN_SELECTION_LENGTH) {
        hideSelectionPopover();
        return;
      }
      const rect = getSelectionRect(selection);
      if (!rect) {
        hideSelectionPopover();
        return;
      }
      currentSelectionText = text;
      positionSelectionPopover(rect);
    };

    const handleSelectionCopy = async () => {
      if (!currentSelectionText || !selectionCopyBtn) return;
      try {
        await writeToClipboard(currentSelectionText);
        flashState(selectionCopyBtn, "success", "Disalin!");
      } catch (error) {
        console.error(error);
        flashState(selectionCopyBtn, "error", "Gagal");
      }
    };

    const handleSelectionShare = async () => {
      if (!currentSelectionText || !selectionShareBtn) return;
      const payload = {
        title: articleTitle,
        text: currentSelectionText,
        url: articleSourceUrl,
      };
      if (navigator.share) {
        try {
          await navigator.share(payload);
          flashState(selectionShareBtn, "success", "Dibagikan!");
          hideSelectionPopover();
          return;
        } catch (error) {
          if (error?.name === "AbortError") {
            return;
          }
          console.error(error);
        }
      }
      try {
        await writeToClipboard(`${currentSelectionText}\n\n${articleTitle}\n${articleSourceUrl}`);
        flashState(selectionShareBtn, "success", "Link siap!");
      } catch (error) {
        console.error(error);
        flashState(selectionShareBtn, "error", "Gagal");
      }
    };

    selectionCopyBtn?.addEventListener("click", handleSelectionCopy);
    selectionShareBtn?.addEventListener("click", handleSelectionShare);

    const handlePointerUp = () => {
      window.setTimeout(handleSelectionChange, 10);
    };

    document.addEventListener("selectionchange", handleSelectionChange);
    document.addEventListener("mouseup", handlePointerUp);
    document.addEventListener("keyup", (event) => {
      if (event.key === "Escape") {
        hideSelectionPopover();
        window.getSelection()?.removeAllRanges();
        return;
      }
      handleSelectionChange();
    });
    document.addEventListener("touchend", handlePointerUp, { passive: true });
    window.addEventListener("scroll", hideSelectionPopover, { passive: true });
  })();
</script>

<style>
  .selection-share {
    position: absolute;
    left: var(--selection-share-left, -9999px);
    top: var(--selection-share-top, -9999px);
    transform: translate(-50%, calc(-100% - 12px));
    z-index: 60;
    pointer-events: none;
    opacity: 0;
    transition: opacity 160ms ease, transform 160ms ease;
  }

  .selection-share[data-visible="true"] {
    opacity: 1;
    transform: translate(-50%, calc(-100% - 16px));
  }

  .selection-share__actions {
    position: relative;
    display: inline-flex;
    gap: 0.35rem;
    padding: 0.35rem;
    border-radius: 999px;
    border: 2px solid rgba(0, 0, 0, 0.7);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
    pointer-events: auto;
  }

  .selection-share__actions::after {
    content: "";
    position: absolute;
    left: 50%;
    bottom: -8px;
    transform: translateX(-50%);
    border-width: 8px 8px 0 8px;
    border-style: solid;
    border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
    filter: drop-shadow(0 2px 4px rgba(15, 23, 42, 0.25));
  }

  .selection-share__button {
    border: none;
    background: transparent;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #111;
  }

  .selection-share__button i {
    font-size: 0.9rem;
  }

  .selection-share__button--accent {
    background: rgba(16, 185, 129, 0.12);
    color: #047857;
  }

  :global(.dark) .selection-share__actions {
    border-color: rgba(255, 255, 255, 0.3);
    background: rgba(24, 24, 27, 0.95);
  }

  :global(.dark) .selection-share__actions::after {
    border-color: rgba(24, 24, 27, 0.95) transparent transparent transparent;
  }

  :global(.dark) .selection-share__button {
    color: #f4f4f5;
  }

  :global(.dark) .selection-share__button--accent {
    color: #bbf7d0;
  }

  @media (max-width: 640px) {
    .selection-share__actions {
      padding: 0.25rem;
    }

    .selection-share__button {
      padding: 0.3rem 0.7rem;
      font-size: 0.75rem;
    }

    .selection-share__button i {
      font-size: 0.8rem;
    }
  }
</style>
