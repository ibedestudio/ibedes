---
import fs from "node:fs/promises";
import path from "node:path";
import matter from "gray-matter";
import Layout from "../../layouts/Layout.astro";
import { affiliateProducts } from "../../lib/affiliates";
import { GLOBAL } from "../../lib/variables";

export const prerender = false;

const { searchParams } = Astro.url;
const filename = searchParams.get("file");

interface Frontmatter {
    title: string;
    description: string;
    pubDate: string | Date;
    affiliateProducts: string[];
    affiliateContext: string;
    featuredImage?: string;
    [key: string]: any;
}

let content = "";
let frontmatter: Frontmatter = {
    title: "",
    description: "",
    pubDate: new Date().toISOString().split("T")[0],
    affiliateProducts: [],
    affiliateContext: "",
};

if (filename) {
    try {
        const filePath = path.join(process.cwd(), "src/pages/blog", filename);
        const fileContent = await fs.readFile(filePath, "utf-8");
        const parsed = matter(fileContent);
        content = parsed.content;
        frontmatter = { ...frontmatter, ...parsed.data };
        // Handle date format if it's a Date object
        if (frontmatter.pubDate instanceof Date) {
            frontmatter.pubDate = frontmatter.pubDate
                .toISOString()
                .split("T")[0];
        }
    } catch (e) {
        console.error("Error reading file", e);
    }
}

const allProducts = affiliateProducts;
---

<Layout title={`Editor - ${GLOBAL.username}`}>
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"
        >
            <div class="flex items-center gap-4">
                <a
                    href="/admin"
                    class="text-muted-foreground hover:text-foreground transition-colors"
                >
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </a>
                <h1
                    class="text-2xl sm:text-3xl font-display uppercase tracking-wider"
                >
                    {filename ? "Edit Article" : "New Article"}
                </h1>
            </div>
            <div class="flex gap-2 w-full sm:w-auto">
                <a
                    id="view-article-btn"
                    href="#"
                    target="_blank"
                    class="cta-button cta-button--secondary hidden items-center justify-center gap-2 flex-1 sm:flex-initial"
                >
                    <i class="fa-solid fa-eye"></i> View Article
                </a>
                <button
                    id="save-btn"
                    class="cta-button cta-button--primary flex items-center justify-center gap-2 flex-1 sm:flex-initial"
                >
                    <i class="fa-solid fa-save"></i> Save Changes
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Editor -->
            <div class="lg:col-span-2 space-y-6">
                <div
                    class="zag-bg border-[3px] border-black/60 dark:border-white/70 rounded-xl p-6 shadow-sm h-full flex flex-col"
                >
                    <label class="block text-sm font-mono font-bold mb-2"
                        >Article Content (Markdown)</label
                    >
                    <textarea
                        id="content-editor"
                        class="w-full min-h-[60vh] lg:h-[600px] rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-3 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300 resize-y leading-relaxed flex-grow"
                        placeholder="Write your article here..."
                        >{content}</textarea
                    >
                </div>
            </div>

            <!-- Sidebar Settings -->
            <div class="space-y-6">
                <div
                    class="zag-bg border-[3px] border-black/60 dark:border-white/70 rounded-xl p-6 shadow-sm space-y-4"
                >
                    <h3
                        class="text-lg font-serif font-bold border-b-[3px] border-black/60 dark:border-white/70 pb-2 mb-4"
                    >
                        Meta Data
                    </h3>

                    <div>
                        <label class="block text-xs font-mono font-bold mb-1"
                            >Filename (e.g., my-post.md)</label
                        >
                        <input
                            type="text"
                            id="filename-input"
                            value={filename || ""}
                            disabled={!!filename}
                            class="w-full rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300 disabled:opacity-50"
                        />
                    </div>

                    <div>
                        <label class="block text-xs font-mono font-bold mb-1"
                            >Title</label
                        >
                        <input
                            type="text"
                            id="title-input"
                            value={frontmatter.title}
                            class="w-full rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300"
                        />
                    </div>

                    <div>
                        <label class="block text-xs font-mono font-bold mb-1"
                            >Description</label
                        >
                        <textarea
                            id="desc-input"
                            rows="3"
                            class="w-full rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300 resize-none"
                            >{frontmatter.description}</textarea
                        >
                    </div>

                    <div>
                        <label class="block text-xs font-mono font-bold mb-1"
                            >Publish Date</label
                        >
                        <input
                            type="date"
                            id="date-input"
                            value={frontmatter.pubDate instanceof Date
                                ? frontmatter.pubDate
                                      .toISOString()
                                      .split("T")[0]
                                : frontmatter.pubDate}
                            class="w-full rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300"
                        />
                    </div>

                    <div>
                        <label class="block text-xs font-mono font-bold mb-1"
                            >Featured Image</label
                        >
                        <div class="flex gap-2">
                            <input
                                type="url"
                                id="image-input"
                                value={frontmatter.featuredImage || ""}
                                placeholder="https://example.com/image.jpg"
                                class="flex-1 rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300"
                            />
                            <label class="cursor-pointer">
                                <input
                                    type="file"
                                    id="file-upload"
                                    accept="image/*"
                                    class="hidden"
                                />
                                <div
                                    class="h-full px-4 flex items-center justify-center rounded-xl border-[3px] border-black/60 dark:border-white/70 hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
                                    title="Upload Image"
                                >
                                    <i class="fa-solid fa-upload"></i>
                                </div>
                            </label>
                        </div>
                        <div id="image-preview" class="mt-2 hidden">
                            <img
                                src=""
                                alt="Preview"
                                class="h-32 w-auto rounded-lg border border-black/20 dark:border-white/20 object-cover"
                            />
                        </div>

                        <div class="mt-3">
                            <label
                                class="block text-xs font-mono font-bold mb-1"
                                >Image Alt Text</label
                            >
                            <input
                                type="text"
                                id="image-alt-input"
                                value={frontmatter.featuredImageAlt || ""}
                                placeholder="Description for accessibility"
                                class="w-full rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300"
                            />
                        </div>

                        <div class="mt-3">
                            <label
                                class="block text-xs font-mono font-bold mb-1"
                                >Image Caption / Credit</label
                            >
                            <input
                                type="text"
                                id="image-caption-input"
                                value={frontmatter.featuredImageCaption || ""}
                                placeholder="e.g. Foto oleh Giorgio Trovato di Unsplash"
                                class="w-full rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300"
                            />
                        </div>

                        <p class="text-xs text-muted-foreground mt-1 font-mono">
                            Enter URL or upload an image
                        </p>
                    </div>
                </div>

                <div
                    class="zag-bg border-[3px] border-black/60 dark:border-white/70 rounded-xl p-6 shadow-sm space-y-4"
                >
                    <h3
                        class="text-lg font-serif font-bold border-b-[3px] border-black/60 dark:border-white/70 pb-2 mb-4"
                    >
                        Affiliate Settings
                    </h3>

                    <div>
                        <label class="block text-xs font-mono font-bold mb-1"
                            >Context Message</label
                        >
                        <input
                            type="text"
                            id="affiliate-context"
                            value={frontmatter.affiliateContext || ""}
                            placeholder="e.g. Recommended Products:"
                            class="w-full rounded-xl border-[3px] border-black/60 dark:border-white/70 bg-transparent px-4 py-2 font-mono text-sm focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400 dark:focus-visible:outline-emerald-300"
                        />
                    </div>

                    <div>
                        <label class="block text-xs font-mono font-bold mb-2"
                            >Select Products</label
                        >
                        <div
                            class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar"
                        >
                            {
                                allProducts.length > 0 ? (
                                    allProducts.map((product) => (
                                        <label class="flex items-start gap-3 p-2 rounded-lg hover:bg-muted/20 cursor-pointer transition-colors group border border-transparent hover:border-black/10 dark:hover:border-white/10">
                                            <input
                                                type="checkbox"
                                                name="affiliate-products"
                                                value={product.id}
                                                checked={
                                                    frontmatter.affiliateProducts &&
                                                    frontmatter.affiliateProducts.includes(
                                                        product.id,
                                                    )
                                                }
                                                class="mt-1 rounded border-black/60 dark:border-white/70 text-primary focus:ring-primary"
                                            />
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-bold group-hover:text-primary truncate">
                                                    {product.name}
                                                </div>
                                                <div class="text-xs text-muted-foreground flex justify-between font-mono">
                                                    <span>
                                                        {product.platform}
                                                    </span>
                                                    <span>{product.price}</span>
                                                </div>
                                            </div>
                                        </label>
                                    ))
                                ) : (
                                    <div class="text-sm text-muted-foreground p-2 text-center italic">
                                        No affiliate products found.
                                    </div>
                                )
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script
            define:vars={{
                initialFilename: filename,
                initialFrontmatter: frontmatter,
            }}
        >
            // Handle file upload
            const fileInput = document.getElementById("file-upload");
            const urlInput = document.getElementById("image-input");
            const imagePreview = document.getElementById("image-preview");
            const previewImg = imagePreview?.querySelector("img");

            // Show View Article button if editing existing article
            if (initialFilename) {
                const viewBtn = document.getElementById("view-article-btn");
                const articleSlug = initialFilename.replace(".md", "");
                const articleUrl = `/blog/${articleSlug}`;

                if (viewBtn) {
                    viewBtn.href = articleUrl;
                    viewBtn.classList.remove("hidden");
                    viewBtn.classList.add("flex");
                }
            }

            function updatePreview() {
                const url = urlInput.value.trim();
                if (url && imagePreview && previewImg) {
                    previewImg.src = url;
                    imagePreview.classList.remove("hidden");
                } else if (imagePreview) {
                    imagePreview.classList.add("hidden");
                }
            }

            urlInput?.addEventListener("input", updatePreview);
            // Initial check
            updatePreview();

            fileInput?.addEventListener("change", async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                const formData = new FormData();
                formData.append("file", file);

                // Show loading state
                const uploadBtn = fileInput.parentElement?.querySelector("div");
                const originalContent = uploadBtn?.innerHTML;
                if (uploadBtn) {
                    uploadBtn.innerHTML =
                        '<i class="fa-solid fa-spinner fa-spin"></i>';
                    uploadBtn.style.pointerEvents = "none";
                }

                try {
                    const response = await fetch("/api/admin/upload", {
                        method: "POST",
                        body: formData,
                    });

                    const result = await response.json();

                    if (response.ok) {
                        urlInput.value = result.url;
                        updatePreview();
                        if (typeof window.showToast === "function") {
                            window.showToast("Image uploaded successfully!", {
                                type: "success",
                            });
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error("Upload error:", error);
                    if (typeof window.showToast === "function") {
                        window.showToast(
                            error.message || "Failed to upload image",
                            { type: "error" },
                        );
                    } else {
                        alert("Failed to upload image");
                    }
                } finally {
                    // Restore button state
                    if (uploadBtn && originalContent) {
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = "auto";
                    }
                    // Clear input
                    fileInput.value = "";
                }
            });

            const saveBtn = document.getElementById("save-btn");

            saveBtn.addEventListener("click", async () => {
                const filenameInput = document.getElementById("filename-input");
                let filename = filenameInput.value.trim();

                if (!filename) {
                    alert("Please enter a filename");
                    return;
                }

                if (!filename.endsWith(".md")) {
                    filename += ".md";
                }

                const title = document.getElementById("title-input").value;
                const description = document.getElementById("desc-input").value;
                const pubDate = document.getElementById("date-input").value;
                const featuredImage =
                    document.getElementById("image-input").value;
                const featuredImageAlt =
                    document.getElementById("image-alt-input").value;
                const featuredImageCaption = document.getElementById(
                    "image-caption-input",
                ).value;
                const affiliateContext =
                    document.getElementById("affiliate-context").value;
                const contentBody =
                    document.getElementById("content-editor").value;

                // Get selected products
                const selectedProducts = Array.from(
                    document.querySelectorAll(
                        'input[name="affiliate-products"]:checked',
                    ),
                ).map((cb) => cb.value);

                // Construct Frontmatter
                const escapeYaml = (str) => str.replace(/"/g, '\\"');

                // Start with existing frontmatter to preserve other fields (like layout, tags, etc)
                // We exclude the fields we are explicitly handling to avoid duplicates
                const {
                    title: _,
                    description: __,
                    pubDate: ___,
                    featuredImage: ____,
                    featuredImageAlt: _____,
                    featuredImageCaption: ______,
                    affiliateProducts: _______,
                    affiliateContext: ________,
                    ...preservedFrontmatter
                } = initialFrontmatter;

                // Ensure layout is present if it wasn't there
                if (!preservedFrontmatter.layout) {
                    preservedFrontmatter.layout =
                        "../../layouts/BlogLayout.astro";
                }

                const frontmatterLines = ["---"];

                // Add preserved fields
                for (const [key, value] of Object.entries(
                    preservedFrontmatter,
                )) {
                    if (Array.isArray(value)) {
                        frontmatterLines.push(`${key}:`);
                        value.forEach((item) =>
                            frontmatterLines.push(`  - "${item}"`),
                        );
                    } else if (typeof value === "object" && value !== null) {
                        // Simple object handling (might need recursion for complex objects, but sufficient for now)
                        frontmatterLines.push(`${key}:`);
                        for (const [k, v] of Object.entries(value)) {
                            frontmatterLines.push(`  ${k}: "${v}"`);
                        }
                    } else {
                        frontmatterLines.push(
                            `${key}: ${JSON.stringify(value)}`,
                        );
                    }
                }

                // Add explicitly managed fields
                frontmatterLines.push(`title: "${escapeYaml(title)}"`);
                frontmatterLines.push(
                    `description: "${escapeYaml(description)}"`,
                );
                frontmatterLines.push(`pubDate: "${pubDate}"`);

                if (featuredImage) {
                    frontmatterLines.push(
                        `featuredImage: "${escapeYaml(featuredImage)}"`,
                    );
                }

                if (featuredImageAlt) {
                    frontmatterLines.push(
                        `featuredImageAlt: "${escapeYaml(featuredImageAlt)}"`,
                    );
                }

                if (featuredImageCaption) {
                    frontmatterLines.push(
                        `featuredImageCaption: "${escapeYaml(featuredImageCaption)}"`,
                    );
                }

                if (selectedProducts.length > 0) {
                    frontmatterLines.push("affiliateProducts:");
                    selectedProducts.forEach((id) => {
                        frontmatterLines.push(`  - "${id}"`);
                    });
                }

                if (affiliateContext) {
                    frontmatterLines.push(
                        `affiliateContext: "${escapeYaml(affiliateContext)}"`,
                    );
                }

                frontmatterLines.push("---");
                frontmatterLines.push("");
                frontmatterLines.push(contentBody);

                const fullContent = frontmatterLines.join("\n");

                try {
                    saveBtn.innerHTML =
                        '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
                    saveBtn.disabled = true;

                    const response = await fetch("/api/admin/save", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            filename,
                            content: fullContent,
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Show success toast
                        if (typeof window.showToast === "function") {
                            window.showToast("Article saved successfully!", {
                                type: "success",
                            });
                        }

                        // Show View Article button
                        const viewBtn =
                            document.getElementById("view-article-btn");
                        const articleSlug = filename.replace(".md", "");
                        const articleUrl = `/blog/${articleSlug}`;

                        if (viewBtn) {
                            viewBtn.href = articleUrl;
                            viewBtn.classList.remove("hidden");
                            viewBtn.classList.add("flex");
                        }

                        saveBtn.innerHTML =
                            '<i class="fa-solid fa-check"></i> Saved!';
                        saveBtn.classList.remove(
                            "bg-green-600",
                            "hover:bg-green-700",
                        );
                        saveBtn.classList.add(
                            "bg-blue-600",
                            "hover:bg-blue-700",
                        );

                        setTimeout(() => {
                            saveBtn.innerHTML =
                                '<i class="fa-solid fa-save"></i> Save Changes';
                            saveBtn.classList.add(
                                "bg-green-600",
                                "hover:bg-green-700",
                            );
                            saveBtn.classList.remove(
                                "bg-blue-600",
                                "hover:bg-blue-700",
                            );
                            saveBtn.disabled = false;

                            if (!initialFilename) {
                                window.location.href = `/admin/editor?file=${filename}`;
                            }
                        }, 2000);
                    } else {
                        alert("Error saving: " + result.error);
                        saveBtn.innerHTML =
                            '<i class="fa-solid fa-save"></i> Save Changes';
                        saveBtn.disabled = false;
                    }
                } catch (e) {
                    console.error(e);
                    // Show error toast
                    if (typeof window.showToast === "function") {
                        window.showToast("Failed to save article", {
                            type: "error",
                        });
                    }
                    saveBtn.innerHTML =
                        '<i class="fa-solid fa-save"></i> Save Changes';
                    saveBtn.disabled = false;
                }
            });
        </script>
    </div>
</Layout>
