---
// Enhanced Search Component with Filters
import { getSearchItems } from "../lib/search";

interface Props {
  isOpen: boolean;
}

const { isOpen } = Astro.props;

// Get search items
const searchItems = await getSearchItems();

// Extract all available tags
const allTags = [...new Set(searchItems.flatMap(item => item.tags || []))].sort();
---

{isOpen && (
  <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-16" data-enhanced-search>
    <div class="command-panel w-full max-w-4xl max-h-[90vh] overflow-hidden">
      <!-- Search Header -->
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold zag-text font-display">Pencarian Cerdas</h2>
        <button
          onclick="this.closest('[data-enhanced-search]').style.display='none'"
          class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Search Input -->
      <div class="relative mb-4">
        <input
          type="text"
          placeholder="Cari artikel, layanan, atau proyek..."
          class="command-panel__input"
          id="enhanced-search-input"
          oninput="handleEnhancedSearch(this.value)"
        />
        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
        <!-- Content Type Filter -->
        <div>
          <label class="block text-sm font-medium zag-text mb-2">Jenis Konten</label>
          <select class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 zag-text text-sm"
                  onchange="filterByType(this.value)">
            <option value="all">Semua</option>
            <option value="article">Artikel</option>
            <option value="service">Layanan</option>
            <option value="project">Proyek</option>
          </select>
        </div>

        <!-- Sort By -->
        <div>
          <label class="block text-sm font-medium zag-text mb-2">Urutkan</label>
          <select class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 zag-text text-sm"
                  onchange="sortResults(this.value)">
            <option value="relevance">Relevansi</option>
            <option value="date">Tanggal</option>
            <option value="title">Judul</option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="flex items-end">
          <button
            onclick="clearAllFilters()"
            class="w-full px-4 py-2 text-sm bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-800 transition-colors"
          >
            Reset Filter
          </button>
        </div>
      </div>

      <!-- Tag Filters -->
      <div class="mb-6">
        <label class="block text-sm font-medium zag-text mb-2">Filter Tags</label>
        <div class="flex flex-wrap gap-2">
          {allTags.slice(0, 12).map((tag) => (
            <button
              onclick={`toggleTag('${tag}')`}
              class="filter-chip"
              data-tag={tag}
            >
              {tag}
            </button>
          ))}
        </div>
      </div>

      <!-- Search Results -->
      <div class="command-panel__results" id="enhanced-search-results">
        <div class="space-y-2" id="search-results-list">
          {searchItems.map((item) => (
            <div class="command-item" data-type={item.type}>
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="command-item__title font-medium zag-text mb-1">
                    {item.title}
                  </div>
                  <div class="command-item__meta text-xs zag-muted mb-2">
                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">
                      {item.type === 'article' ? 'ğŸ“ Artikel' : 
                       item.type === 'service' ? 'ğŸ› ï¸ Layanan' : 'ğŸš€ Proyek'}
                    </span>
                    <span class="ml-2">{item.description}</span>
                  </div>
                  {item.tags && item.tags.length > 0 && (
                    <div class="flex flex-wrap gap-1">
                      {item.tags.slice(0, 3).map((tag) => (
                        <span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 text-xs rounded">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
                <button
                  onclick={`navigateToResult('${item.url}')`}
                  class="px-3 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors ml-4"
                >
                  Buka
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Search Shortcuts -->
      <div class="command-shortcuts mt-4 text-center">
        <p class="mb-2">Keyboard Shortcuts:</p>
        <div class="flex justify-center gap-4 text-xs">
          <kbd>â†‘â†“</kbd> Navigate
          <kbd>Enter</kbd> Open
          <kbd>Esc</kbd> Close
          <kbd>Ctrl+K</kbd> Quick Search
        </div>
      </div>
    </div>
  </div>
)}

<script>
  // Global state
  let searchItems = {searchItems};
  let searchQuery = '';
  let selectedFilters = {
    type: 'all',
    tags: [],
    sortBy: 'relevance'
  };

  // Enhanced search functionality
  function handleEnhancedSearch(query) {
    searchQuery = query;
    filterAndSortResults();
  }

  function filterByType(type) {
    selectedFilters.type = type;
    filterAndSortResults();
  }

  function sortResults(sortBy) {
    selectedFilters.sortBy = sortBy;
    filterAndSortResults();
  }

  function toggleTag(tag) {
    const tagIndex = selectedFilters.tags.indexOf(tag);
    if (tagIndex > -1) {
      selectedFilters.tags.splice(tagIndex, 1);
    } else {
      selectedFilters.tags.push(tag);
    }
    
    // Update UI
    const tagButton = document.querySelector(`[data-tag="${tag}"]`);
    if (tagButton) {
      tagButton.classList.toggle('is-active', tagIndex === -1);
    }
    
    filterAndSortResults();
  }

  function clearAllFilters() {
    searchQuery = '';
    selectedFilters = {
      type: 'all',
      tags: [],
      sortBy: 'relevance'
    };
    
    // Reset UI
    const input = document.getElementById('enhanced-search-input');
    if (input) input.value = '';
    document.querySelectorAll('[data-tag]').forEach(btn => btn.classList.remove('is-active'));
    filterAndSortResults();
  }

  function navigateToResult(url) {
    window.location.href = url;
  }

  // Filter and sort results
  function filterAndSortResults() {
    let results = searchItems || [];
    const query = searchQuery.toLowerCase();
    const filters = selectedFilters;

    // Filter by search query
    if (query) {
      results = results.filter(item => 
        item.title.toLowerCase().includes(query) ||
        item.description.toLowerCase().includes(query) ||
        (item.tags && item.tags.some(tag => tag.toLowerCase().includes(query)))
      );
    }

    // Filter by type
    if (filters.type !== 'all') {
      results = results.filter(item => item.type === filters.type);
    }

    // Filter by tags
    if (filters.tags.length > 0) {
      results = results.filter(item => 
        item.tags && filters.tags.some(tag => item.tags.includes(tag))
      );
    }

    // Sort results
    switch (filters.sortBy) {
      case 'title':
        results.sort((a, b) => a.title.localeCompare(b.title));
        break;
      case 'date':
        // This would need actual date data
        break;
      case 'relevance':
      default:
        // Keep original order for relevance
        break;
    }

    updateSearchResults(results);
  }

  // Update search results display
  function updateSearchResults(results) {
    const container = document.getElementById('search-results-list');
    if (!container) return;

    if (results.length === 0) {
      container.innerHTML = `
        <div class="command-empty">
          <p>Tidak ada hasil ditemukan</p>
        </div>
      `;
      return;
    }

    container.innerHTML = results.map(item => `
      <div class="command-item" data-type="${item.type}">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="command-item__title font-medium zag-text mb-1">
              ${item.title}
            </div>
            <div class="command-item__meta text-xs zag-muted mb-2">
              <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">
                ${item.type === 'article' ? 'ğŸ“ Artikel' : 
                 item.type === 'service' ? 'ğŸ› ï¸ Layanan' : 'ğŸš€ Proyek'}
              </span>
              <span class="ml-2">${item.description}</span>
            </div>
            ${item.tags && item.tags.length > 0 ? `
              <div class="flex flex-wrap gap-1">
                ${item.tags.slice(0, 3).map(tag => `
                  <span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 text-xs rounded">
                    ${tag}
                  </span>
                `).join('')}
              </div>
            ` : ''}
          </div>
          <button
            onclick="navigateToResult('${item.url}')"
            class="px-3 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors ml-4"
          >
            Buka
          </button>
        </div>
      </div>
    `).join('');
  }

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    const searchContainer = document.querySelector('[data-enhanced-search]');
    if (!searchContainer || searchContainer.style.display === 'none') return;
    
    const results = document.querySelectorAll('#search-results-list .command-item');
    let currentIndex = -1;
    
    // Find currently selected item
    results.forEach((result, index) => {
      if (result.getAttribute('data-active') === 'true') {
        currentIndex = index;
      }
    });

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        if (currentIndex < results.length - 1) {
          if (results[currentIndex]) results[currentIndex].removeAttribute('data-active');
          if (results[currentIndex + 1]) results[currentIndex + 1].setAttribute('data-active', 'true');
        }
        break;
      case 'ArrowUp':
        e.preventDefault();
        if (currentIndex > 0) {
          if (results[currentIndex]) results[currentIndex].removeAttribute('data-active');
          if (results[currentIndex - 1]) results[currentIndex - 1].setAttribute('data-active', 'true');
        }
        break;
      case 'Enter':
        if (currentIndex >= 0 && results[currentIndex]) {
          results[currentIndex].click();
        }
        break;
      case 'Escape':
        searchContainer.style.display = 'none';
        break;
    }
  });

  // Initialize component
  document.addEventListener('DOMContentLoaded', function() {
    // Focus search input
    setTimeout(function() {
      const input = document.getElementById('enhanced-search-input');
      if (input) input.focus();
    }, 100);
  });
</script>