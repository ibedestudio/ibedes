---
import { GLOBAL } from "../lib/variables";
import Anchor from "./common/Anchor.astro";
import ThemeToggle from "./ThemeToggle.astro";
import NotificationCenter from "./NotificationCenter.astro";
import EnhancedSearch from "./EnhancedSearch.astro";
---

<header
  class="zag-bg zag-border-b zag-transition sticky top-0 w-full z-10"
>
  <div
    class="zag-bg zag-transition sm:hidden relative z-50 py-4 px-4 flex items-center justify-between"
  >
    <button class="p-2" aria-label="Toggle navigation menu" data-nav-toggle>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="32"
        height="32"
        viewBox="0 0 512 512"
        class="zag-fill zag-transition"
      >
        <path d="M80 96h352v32H80zm0 144h352v32H80zm0 144h352v32H80z"></path>
      </svg>
    </button>
    <div class="flex items-center gap-2">
      <button
        type="button"
        class="p-2 rounded-full border border-black/20 dark:border-white/30 sm:hidden"
        aria-label="Buka pencarian global"
        data-enhanced-search-toggle
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-6 h-6 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M15.5 14h-.79l-.28-.27A6 6 0 1 0 14 15.5l.27.28v.79l5 5 1.5-1.5-5-5zm-5.5 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"
            fill="currentColor"
          />
        </svg>
      </button>
      <button
        type="button"
        class="p-2 rounded-full border border-black/20 dark:border-white/30 sm:hidden relative"
        aria-label="Notifikasi"
        data-notification-toggle
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-6 h-6 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
            fill="currentColor"
          />
        </svg>
        <!-- Notification badge -->
        <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden" data-notification-badge></div>
      </button>
    </div>
  </div>
  <nav
    class="zag-bg zag-border-b zag-transition fixed sm:relative inset-x-0 top-0 h-auto sm:px-4 flex flex-col gap-5 py-4 text-lg sm:text-xl sm:flex-row sm:items-center sm:justify-between sm:gap-4 max-w-4xl mx-auto sm:pt-4 sm:border-none"
  >
    <div
      class="flex flex-col font-mono font-medium gap-3 sm:flex-row sm:gap-5 px-4 sm:px-0 mt-16 sm:mt-0 sm:flex-nowrap sm:items-center sm:text-left sm:flex-1"
    >
    {Object.entries(GLOBAL.menu).map((i) => (
      <Anchor url={i[1]}>{i[0]}</Anchor>
    ))}
    <!-- Analytics Link -->
    <Anchor url="/analytics">ðŸ“Š Analytics</Anchor>
    </div>
    <div class="flex gap-3 justify-between px-4 sm:px-0 items-center sm:justify-end sm:flex-shrink-0">
      {GLOBAL.githubProfile && (<Anchor url={GLOBAL.githubProfile} aria-label="Zaggonaut GitHub Repository">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          class="zag-fill zag-transition"
        >
          <path
            d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"
          ></path>
        </svg>
      </Anchor>)}
      
      <!-- Enhanced Search Button -->
      <button
        type="button"
        class="hidden sm:inline-flex items-center gap-2 border border-black/20 dark:border-white/30 rounded-full px-4 py-2 text-[10px] uppercase tracking-[0.35em]"
        data-enhanced-search-toggle
        aria-label="Buka pencarian cerdas (Ctrl+K)"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-4 h-4 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M15.5 14h-.79l-.28-.27A6 6 0 1 0 14 15.5l.27.28v.79l5 5 1.5-1.5-5-5zm-5.5 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"
            fill="currentColor"
          />
        </svg>
        <span>Cari</span>
        <span class="inline-flex gap-1 items-center text-[9px] tracking-[0.25em]">
          <kbd>Ctrl</kbd>+<kbd>K</kbd>
        </span>
      </button>
      
      <!-- Notification Bell -->
      <button
        type="button"
        class="hidden sm:inline-flex items-center gap-2 border border-black/20 dark:border-white/30 rounded-full px-3 py-2 relative"
        data-notification-toggle
        aria-label="Notifikasi"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-4 h-4 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"
            fill="currentColor"
          />
        </svg>
        <span class="text-[10px] uppercase tracking-[0.35em]">Notifikasi</span>
        <!-- Notification badge -->
        <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden" data-notification-badge></div>
      </button>
      
      <ThemeToggle />
    </div>
  </nav>
  
  <!-- Enhanced Search Component -->
  <EnhancedSearch isOpen={false} />
  
  <!-- Notification Center Component -->
  <NotificationCenter isOpen={false} />
</header>

<script>
const navToggle = document.querySelector("[data-nav-toggle]");
const nav = document.querySelector("header nav");
let isNavOpen = false;

// Enhanced search functionality
const searchToggle = document.querySelector("[data-enhanced-search-toggle]");
const searchComponent = document.querySelector("[data-enhanced-search]");

// Notification functionality
const notificationToggle = document.querySelectorAll("[data-notification-toggle]");
const notificationComponent = document.querySelector("[data-notification-center]");
const notificationBadge = document.querySelectorAll("[data-notification-badge]");

const updateNavState = () => {
  if (!nav) return;
  const isMobile = window.matchMedia("(max-width: 640px)").matches;
  if (isMobile) {
    nav.style.transform = isNavOpen ? "translateY(0)" : "translateY(-100%)";
  } else {
    nav.style.transform = "translateY(0)";
    isNavOpen = false;
  }
};

const toggleNav = () => {
  isNavOpen = !isNavOpen;
  updateNavState();
};

const toggleSearch = () => {
  if (searchComponent) {
    searchComponent.style.display = searchComponent.style.display === 'none' ? 'block' : 'none';
  }
};

const toggleNotifications = () => {
  if (notificationComponent) {
    notificationComponent.style.display = notificationComponent.style.display === 'none' ? 'block' : 'none';
  }
};

// Update notification badge
const updateNotificationBadge = () => {
  // This would check for unread notifications
  const hasUnread = false; // Placeholder - implement actual check
  notificationBadge.forEach(badge => {
    if (hasUnread) {
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  });
};

// Event listeners
navToggle?.addEventListener("click", toggleNav);
searchToggle?.addEventListener("click", toggleSearch);
notificationToggle?.forEach(btn => btn.addEventListener("click", toggleNotifications));

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ctrl+K for search
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    toggleSearch();
  }
  
  // ESC to close modals
  if (e.key === 'Escape') {
    if (searchComponent && searchComponent.style.display !== 'none') {
      searchComponent.style.display = 'none';
    }
    if (notificationComponent && notificationComponent.style.display !== 'none') {
      notificationComponent.style.display = 'none';
    }
  }
});

// Initialize
window.addEventListener("resize", updateNavState);
updateNavState();
updateNotificationBadge();

// Check for service worker updates
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.ready.then(registration => {
    console.log('Service Worker ready:', registration);
  });
}
</script>
