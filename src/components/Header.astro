---
import { GLOBAL } from "../lib/variables";
import Anchor from "./common/Anchor.astro";
import ThemeToggle from "./ThemeToggle.astro";
import CommandPalette from "./CommandPalette.astro";
---

<header
  class="zag-bg zag-border-b zag-transition sticky top-0 w-full z-10"
>
  <div
    class="zag-bg zag-transition sm:hidden relative z-50 py-4 px-4 flex items-center justify-between"
  >
    <button class="p-2" aria-label="Toggle navigation menu" aria-expanded="false" data-nav-toggle>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="32"
        height="32"
        viewBox="0 0 512 512"
        class="zag-fill zag-transition"
      >
        <path d="M80 96h352v32H80zm0 144h352v32H80zm0 144h352v32H80z"></path>
      </svg>
    </button>
    <div class="flex items-center gap-2">
      <button
        type="button"
        class="p-2 rounded-full border border-black/20 dark:border-white/30 sm:hidden"
        aria-label="Buka pencarian global"
        data-command-toggle
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-6 h-6 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M15.5 14h-.79l-.28-.27A6 6 0 1 0 14 15.5l.27.28v.79l5 5 1.5-1.5-5-5zm-5.5 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"
            fill="currentColor"
          />
        </svg>
      </button>
    </div>
  </div>
  <nav
    class="zag-bg zag-border-b zag-transition fixed sm:relative inset-x-0 top-16 sm:top-0 h-auto sm:px-4 flex flex-col gap-5 py-4 text-lg sm:text-xl sm:flex-row sm:items-center sm:justify-between sm:gap-4 max-w-4xl mx-auto sm:pt-4 sm:border-none z-40 hidden sm:flex"
    id="main-nav"
  >
    <div
      class="flex flex-col font-mono font-medium gap-3 sm:flex-row sm:gap-5 px-4 sm:px-0 sm:flex-nowrap sm:items-center sm:text-left sm:flex-1"
    >
    {Object.entries(GLOBAL.menu).map((i) => (
      <Anchor url={i[1]}>{i[0]}</Anchor>
    ))}
    </div>
    <div class="flex gap-3 justify-between px-4 sm:px-0 items-center sm:justify-end sm:flex-shrink-0">
      {GLOBAL.githubProfile && (<Anchor url={GLOBAL.githubProfile} aria-label="Zaggonaut GitHub Repository">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          class="zag-fill zag-transition"
        >
          <path
            d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"
          ></path>
        </svg>
      </Anchor>)}
      
      <!-- Enhanced Search Button -->
      <button
        type="button"
        class="hidden sm:inline-flex items-center gap-2 border border-black/20 dark:border-white/30 rounded-full px-4 py-2 text-[10px] uppercase tracking-[0.35em]"
        data-command-toggle
        aria-label="Buka pencarian cerdas (Ctrl+K)"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-4 h-4 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M15.5 14h-.79l-.28-.27A6 6 0 1 0 14 15.5l.27.28v.79l5 5 1.5-1.5-5-5zm-5.5 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"
            fill="currentColor"
          />
        </svg>
        <span>Cari</span>
        <span class="inline-flex gap-1 items-center text-[9px] tracking-[0.25em]">
          <kbd>Ctrl</kbd>+<kbd>K</kbd>
        </span>
      </button>
      
      <ThemeToggle />
    </div>
  </nav>
  
  <!-- Simple Command Palette (original search) -->
  <CommandPalette />
</header>

<script>
const navToggle = document.querySelector("[data-nav-toggle]");
const nav = document.querySelector("header nav");
let isNavOpen = false;


const updateNavState = () => {
  if (!nav) return;
  const isMobile = window.matchMedia("(max-width: 640px)").matches;
  if (isMobile) {
    const navElement = nav as HTMLElement;
    if (isNavOpen) {
      navElement.classList.remove("hidden");
      navElement.classList.add("flex");
    } else {
      navElement.classList.add("hidden");
      navElement.classList.remove("flex");
    }
  } else {
    const navElement = nav as HTMLElement;
    navElement.classList.remove("hidden");
    navElement.classList.add("flex");
    isNavOpen = false;
    const toggleButton = document.querySelector("[data-nav-toggle]") as HTMLElement;
    if (toggleButton) {
      toggleButton.setAttribute("aria-expanded", "false");
    }
  }
};

const toggleNav = () => {
  isNavOpen = !isNavOpen;
  const toggleButton = document.querySelector("[data-nav-toggle]") as HTMLElement;
  if (toggleButton) {
    toggleButton.setAttribute("aria-expanded", isNavOpen.toString());
  }
  updateNavState();
};

// Event listeners
navToggle?.addEventListener("click", toggleNav);

// Keyboard shortcuts for search are handled inside CommandPalette

// Initialize
window.addEventListener("resize", updateNavState);
updateNavState();

// Check for service worker updates
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.ready.then(registration => {
    console.log('Service Worker ready:', registration);
  });
}
</script>
