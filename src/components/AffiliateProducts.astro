---
import { Image } from "astro:assets";
import type { AffiliateProduct } from "../lib/affiliates";
import { platformConfig } from "../lib/affiliates";
import { generateProductSchema } from "../lib/seo";
import { GLOBAL } from "../lib/variables";
import { formatRupiah } from "../lib/utils";
import SkeletonLoader from "./common/SkeletonLoader.astro";

export interface Props {
  products: AffiliateProduct[];
  context?: string;
  title?: string;
  showSkeleton?: boolean;
}

const { products, context, title = "Rekomendasi Produk", showSkeleton = false } = Astro.props;

const sanitizePrice = (value?: string | number) => {
  const digits = value ? String(value).replace(/[^\d]/g, "") : "";
  return digits || "0";
};

// Generate structured data for each product
const productSchemas = products.map(product => 
  generateProductSchema({
    name: product.name,
    description: product.description || context || title || "Rekomendasi Produk",
    image: product.image,
    price: sanitizePrice(product.price),
    currency: 'IDR',
    availability: 'InStock',
    rating: product.rating,
    url: product.link,
  }, GLOBAL.rootUrl)
);
---

{showSkeleton ? (
  <div class="my-8 border-t border-b border-gray-200 dark:border-gray-800 py-6">
    <div class="mb-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
        <i class="fa-solid fa-bag-shopping text-xl"></i>
        {title}
      </h3>
    </div>
    <SkeletonLoader variant="product" count={2} />
  </div>
) : (
<div class="my-8 border-t border-b border-gray-200 dark:border-gray-800 py-6">
  <!-- Header -->
  <div class="mb-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
      <i class="fa-solid fa-bag-shopping text-xl"></i>
      {title}
    </h3>
    {context && (
      <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">
        {context}
      </p>
    )}
  </div>

  <!-- Products Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    {products.map((product) => {
      const platform = platformConfig[product.platform];
      return (
        <a 
          href={product.link}
          target="_blank"
          rel="noopener noreferrer sponsored"
          class="group flex gap-4 p-3 rounded-lg border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200"
          data-affiliate-link
          data-product-id={product.id}
          data-platform={product.platform}
          data-product-name={product.name}
          data-price={product.price}
          aria-label={`Beli ${product.name} di ${platform.name}`}
        >
          <!-- Product Image (Compact) -->
          <div class="relative w-20 h-20 flex-shrink-0 rounded-md overflow-hidden bg-gray-100 dark:bg-gray-900">
            <Image 
              src={product.image} 
              alt={product.name}
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              width={200}
              height={200}
            />
            {product.discount && product.discount !== '-' && (
              <div class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-bl-md">
                -{product.discount}
              </div>
            )}
          </div>

          <!-- Product Info -->
          <div class="flex flex-col justify-between flex-grow min-w-0">
            <div>
              <div class="flex items-start justify-between gap-2">
                <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 leading-tight group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                  {product.name}
                </h4>
                <span 
                  class="text-[10px] px-1.5 py-0.5 rounded text-white whitespace-nowrap flex-shrink-0 opacity-70 group-hover:opacity-100 transition-opacity"
                  style={`background-color: ${platform.color}`}
                >
              <i class={`${platform.icon} mr-1`}></i>
              {platform.name}
                </span>
              </div>
              
              {product.rating && (
                <div class="flex items-center gap-1 mt-1">
                  <i class="fa-solid fa-star text-yellow-400 text-[10px]"></i>
                  <span class="text-xs text-gray-500">{product.rating}</span>
                </div>
              )}
            </div>

            <div class="flex items-center gap-2 mt-2">
              <span class="text-sm font-bold text-gray-900 dark:text-gray-100">
                {formatRupiah(product.price)}
              </span>
              {product.originalPrice && product.originalPrice !== '-' && (
                <span class="text-xs text-gray-400 line-through">
                  {formatRupiah(product.originalPrice)}
                </span>
              )}
            </div>
          </div>
        </a>
      );
    })}
  </div>

  <!-- Footer / Disclosure -->
  <div class="mt-4 flex items-center justify-between gap-4 text-[10px] text-gray-400 dark:text-gray-500">
    <p>
      <i class="fa-solid fa-triangle-exclamation mr-1"></i> <em>Disclosure: Contains affiliate links. I may earn a commission at no extra cost to you.</em>
    </p>
  </div>
</div>

<!-- Structured Data for Products -->
{productSchemas.map((schema) => (
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />
))}

<script is:inline>
  // Enhanced affiliate tracking
  document.addEventListener('DOMContentLoaded', () => {
    const affiliateLinks = document.querySelectorAll('[data-affiliate-link]');
    
    affiliateLinks.forEach((link) => {
      link.addEventListener('click', function(e) {
        const productId = this.getAttribute('data-product-id') || '';
        const platform = this.getAttribute('data-platform') || '';
        const productName = this.getAttribute('data-product-name') || '';
        const price = this.getAttribute('data-price') || '';
        
        // Track with Google Analytics if available
        if (typeof window.gtag === 'function') {
          window.gtag('event', 'affiliate_click', {
            product_id: productId,
            platform: platform,
            product_name: productName,
            price: price,
            event_category: 'Affiliate',
            event_label: productName,
          });
        }
        
        // Track with custom analytics if available
        if (typeof window.trackAffiliateClick === 'function') {
          window.trackAffiliateClick(productId, platform, productName, price);
        }
        
        // Visual feedback
        this.style.transform = 'scale(0.98)';
        setTimeout(() => {
          this.style.transform = '';
        }, 100);
      });
      
      // Add hover effect for better UX
      link.addEventListener('mouseenter', function() {
        this.style.transition = 'transform 0.2s ease';
      });
    });
  });
</script>


<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
)}
