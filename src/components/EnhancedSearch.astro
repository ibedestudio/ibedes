---
// Enhanced Search Component with Filters
import { getSearchItems } from "../lib/search";

interface Props {
   isOpen: boolean;
}

const { isOpen } = Astro.props;

// Get search items for initial render and tag extraction
const searchItems = await getSearchItems();

// Extract all available tags
const allTags = [...new Set(searchItems.flatMap(item => item.tags || []))].sort();

// For client-side, we'll fetch fresh data from API but hydrate with SSR data first
const searchItemsJSON = JSON.stringify(searchItems);
---

<div class={`fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-16 ${isOpen ? '' : 'hidden'}`} data-enhanced-search aria-hidden={!isOpen}>
    <div class="command-panel w-full max-w-4xl max-h-[90vh] overflow-hidden">
      <!-- Search Header -->
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold zag-text font-display">Pencarian Cerdas</h2>
        <button
          onclick="this.closest('[data-enhanced-search]').classList.add('hidden')"
          class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Search Input -->
      <div class="relative mb-4">
        <input
          type="text"
          placeholder="Cari artikel, layanan, atau proyek..."
          class="command-panel__input"
          id="enhanced-search-input"
        />
        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
        <!-- Content Type Filter -->
        <div>
          <label class="block text-sm font-medium zag-text mb-2">Jenis Konten</label>
          <select class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 zag-text text-sm"
                  onchange="filterByType(this.value)">
            <option value="all">Semua</option>
            <option value="article">Artikel</option>
            <option value="service">Layanan</option>
            <option value="project">Proyek</option>
          </select>
        </div>

        <!-- Sort By -->
        <div>
          <label class="block text-sm font-medium zag-text mb-2">Urutkan</label>
          <select class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 zag-text text-sm"
                  onchange="sortResults(this.value)">
            <option value="relevance">Relevansi</option>
            <option value="date">Tanggal</option>
            <option value="title">Judul</option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="flex items-end">
          <button
            onclick="clearAllFilters()"
            class="w-full px-4 py-2 text-sm bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-800 transition-colors"
          >
            Reset Filter
          </button>
        </div>
      </div>

      <!-- Tag Filters -->
      <div class="mb-6">
        <label class="block text-sm font-medium zag-text mb-2">Filter Tags</label>
        <div class="flex flex-wrap gap-2">
          {allTags.slice(0, 12).map((tag) => (
            <button
              class="filter-chip"
              type="button"
              data-tag={tag}
            >
              {tag}
            </button>
          ))}
        </div>
      </div>

      <!-- Search Results -->
      <div class="command-panel__results" id="enhanced-search-results">
        <div class="space-y-2" id="search-results-list">
          <!-- Results will be loaded dynamically -->
        </div>
        <div id="search-results-status" class="text-center text-sm text-gray-500 dark:text-gray-400 py-3 hidden"></div>
      </div>

      <!-- Search Shortcuts -->
      <div class="command-shortcuts mt-4 text-center">
        <p class="mb-2">Keyboard Shortcuts:</p>
        <div class="flex justify-center gap-4 text-xs">
          <kbd>â†‘â†“</kbd> Navigate
          <kbd>Enter</kbd> Open
          <kbd>Esc</kbd> Close
          <kbd>Ctrl+K</kbd> Quick Search
        </div>
      </div>
    </div>
  </div>

<script define:vars={{ searchItemsJSON }}>
   // Global state
   let searchItems = [];
   let searchQuery = '';
   let selectedFilters = {
     type: 'all',
     tags: [],
     sortBy: 'relevance'
   };
   let isInitialized = false;
   let isLoading = false;
   let hasError = false;

   // Fetch search items from API
   async function loadSearchItems() {
     setStatus('Memuat data pencarianâ€¦', 'loading');
     isLoading = true;
     hasError = false;
     try {
       const response = await fetch('/api/search.json');
       if (response.ok) {
         searchItems = await response.json();
         filterAndSortResults();
         clearStatus();
       } else {
         console.error('Failed to load search items');
         setStatus('Gagal memuat data pencarian', 'error');
         hasError = true;
       }
     } catch (error) {
       console.error('Error loading search items:', error);
       setStatus('Terjadi kesalahan saat memuat hasil', 'error');
       hasError = true;
     }

     isLoading = false;
   }

  // Enhanced search functionality
  function handleEnhancedSearch(query) {
    searchQuery = query;
    filterAndSortResults();
  }

  function filterByType(type) {
    selectedFilters.type = type;
    filterAndSortResults();
  }

  function sortResults(sortBy) {
    selectedFilters.sortBy = sortBy;
    filterAndSortResults();
  }

  function toggleTag(tagButton) {
    if (!tagButton) return;
    const tag = tagButton.dataset.tag;
    if (!tag) return;

    const tagIndex = selectedFilters.tags.indexOf(tag);
    if (tagIndex > -1) {
      selectedFilters.tags.splice(tagIndex, 1);
    } else {
      selectedFilters.tags.push(tag);
    }

    tagButton.classList.toggle('is-active', tagIndex === -1);

    filterAndSortResults();
  }

  function clearAllFilters() {
    searchQuery = '';
    selectedFilters = {
      type: 'all',
      tags: [],
      sortBy: 'relevance'
    };
    
    // Reset UI
    const input = document.getElementById('enhanced-search-input');
    if (input) input.value = '';
    document.querySelectorAll('[data-tag]').forEach(btn => btn.classList.remove('is-active'));
    filterAndSortResults();
  }

  function navigateToResult(url) {
    window.location.href = url;
  }

  // Filter and sort results
  function filterAndSortResults() {
    let results = searchItems || [];
    const query = searchQuery.toLowerCase();
    const filters = selectedFilters;

    // Filter by search query
    if (query) {
      results = results.filter(item => {
        const title = (item.title || '').toLowerCase();
        const desc = (item.description || '').toLowerCase();
        const tags = Array.isArray(item.tags) ? item.tags : [];
        return (
          title.includes(query) ||
          desc.includes(query) ||
          tags.some(tag => (tag || '').toLowerCase().includes(query))
        );
      });
    }

    // Filter by type
    if (filters.type !== 'all') {
      results = results.filter(item => item.type === filters.type);
    }

    // Filter by tags
    if (filters.tags.length > 0) {
      results = results.filter(item => 
        item.tags && filters.tags.some(tag => item.tags.includes(tag))
      );
    }

    // Sort results
    switch (filters.sortBy) {
      case 'title':
        results.sort((a, b) => a.title.localeCompare(b.title));
        break;
      case 'date':
        results.sort((a, b) => {
          const dateA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
          const dateB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
          return dateB - dateA; // Newer first
        });
        break;
      case 'relevance':
      default:
        // Keep original order for relevance
        break;
    }

    updateSearchResults(results);
  }

  // Update search results display
  function updateSearchResults(results) {
    const container = document.getElementById('search-results-list');
    if (!container) return;

    container.replaceChildren();
    if (isLoading) {
      return;
    }
    if (hasError) {
      return;
    }
    if (results.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'command-empty';
      const emptyText = document.createElement('p');
      emptyText.textContent = 'Tidak ada hasil ditemukan';
      empty.appendChild(emptyText);
      container.appendChild(empty);
      return;
    }

    results.forEach(item => {
      const commandItem = document.createElement('div');
      commandItem.className = 'command-item';
      commandItem.dataset.type = item.type;

      const layout = document.createElement('div');
      layout.className = 'flex items-start justify-between';
      commandItem.appendChild(layout);

      const textColumn = document.createElement('div');
      textColumn.className = 'flex-1';
      layout.appendChild(textColumn);

      const title = document.createElement('div');
      title.className = 'command-item__title font-medium zag-text mb-1';
      title.textContent = item.title || '';
      textColumn.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'command-item__meta text-xs zag-muted mb-2';
      const badge = document.createElement('span');
      badge.className = 'px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs';
      const typeLabel =
        item.type === 'article'
          ? 'ðŸ“ Artikel'
          : item.type === 'service'
            ? 'ðŸ› ï¸ Layanan'
            : 'ðŸš€ Proyek';
      badge.textContent = typeLabel;
      meta.appendChild(badge);

      if (item.description) {
        const description = document.createElement('span');
        description.className = 'ml-2';
        description.textContent = item.description;
        meta.appendChild(description);
      }
      textColumn.appendChild(meta);

      if (Array.isArray(item.tags) && item.tags.length > 0) {
        const tagsWrapper = document.createElement('div');
        tagsWrapper.className = 'flex flex-wrap gap-1';
        item.tags.slice(0, 3).forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'px-2 py-1 bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 text-xs rounded';
          tagEl.textContent = tag;
          tagsWrapper.appendChild(tagEl);
        });
        textColumn.appendChild(tagsWrapper);
      }

      const actionButton = document.createElement('button');
      actionButton.type = 'button';
      actionButton.className = 'px-3 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors ml-4';
      actionButton.textContent = 'Buka';
      actionButton.addEventListener('click', event => {
        event.stopPropagation();
        navigateToResult(item.url);
      });
      layout.appendChild(actionButton);

      commandItem.addEventListener('click', () => {
        navigateToResult(item.url);
      });

      container.appendChild(commandItem);
    });
  }

  const overlay = document.querySelector('[data-enhanced-search]');

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    const searchContainer = overlay;
    if (!searchContainer || searchContainer.classList.contains('hidden')) return;
    
    const results = document.querySelectorAll('#search-results-list .command-item');
    let currentIndex = -1;
    
    // Find currently selected item
    results.forEach((result, index) => {
      if (result.getAttribute('data-active') === 'true') {
        currentIndex = index;
      }
    });

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        if (currentIndex < results.length - 1) {
          if (results[currentIndex]) results[currentIndex].removeAttribute('data-active');
          if (results[currentIndex + 1]) results[currentIndex + 1].setAttribute('data-active', 'true');
        }
        break;
      case 'ArrowUp':
        e.preventDefault();
        if (currentIndex > 0) {
          if (results[currentIndex]) results[currentIndex].removeAttribute('data-active');
          if (results[currentIndex - 1]) results[currentIndex - 1].setAttribute('data-active', 'true');
        }
        break;
      case 'Enter':
        if (currentIndex >= 0 && results[currentIndex]) {
          results[currentIndex].click();
        }
        break;
      case 'Escape':
        searchContainer.classList.add('hidden');
        searchContainer.setAttribute('aria-hidden', 'true');
        break;
    }
  });

  const openOverlay = () => {
    if (!overlay) return;
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    initEnhancedSearch();
    const input = document.getElementById('enhanced-search-input');
    if (input) input.focus();
  };

  const closeOverlay = () => {
    if (!overlay) return;
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden', 'true');
  };

  const toggleOverlay = () => {
    if (!overlay) return;
    const isHidden = overlay.classList.contains('hidden');
    if (isHidden) {
      openOverlay();
    } else {
      closeOverlay();
    }
  };

  // Toggle buttons
  const toggleButtons = Array.from(document.querySelectorAll('[data-enhanced-search-toggle]'));
  toggleButtons.forEach((btn) => btn.addEventListener('click', (e) => {
    e.preventDefault();
    toggleOverlay();
  }));

  // Close when clicking backdrop
  overlay?.addEventListener('click', (event) => {
    if (event.target === overlay) {
      closeOverlay();
    }
  });

  // Global keyboard shortcut
  document.addEventListener('keydown', (event) => {
    const metaKey = event.metaKey || event.ctrlKey;
    if (metaKey && event.key.toLowerCase() === 'k') {
      event.preventDefault();
      openOverlay();
    }
    if (event.key === 'Escape' && overlay && !overlay.classList.contains('hidden')) {
      closeOverlay();
    }
  });

  // Initialize component (idempotent)
  function initEnhancedSearch() {
    if (isInitialized) return;
    isInitialized = true;

    // Hydrate with initial SSR data before fetching fresh data
    try {
      const initialItems = JSON.parse(searchItemsJSON);
      if (Array.isArray(initialItems) && initialItems.length > 0) {
        searchItems = initialItems;
        filterAndSortResults();
      }
    } catch (error) {
      console.error('Failed to hydrate search items', error);
    }

    // Add input event listener for search
    const input = document.getElementById('enhanced-search-input');
    if (input) {
      input.addEventListener('input', function(e) {
        // Plain JS for browser compatibility
        // @ts-ignore - target is HTMLInputElement
        handleEnhancedSearch(e.target && e.target.value ? e.target.value : '');
      });

      // Focus search input when panel is first shown
      setTimeout(function() {
        input.focus();
      }, 100);
    }

    document.querySelectorAll('[data-tag]').forEach(button => {
      button.addEventListener('click', () => toggleTag(button));
    });

    // Load search items from API immediately
    loadSearchItems();
  }

  // Run init now if DOM already loaded; otherwise wait for DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEnhancedSearch);
  } else {
    initEnhancedSearch();
  }

  // Also initialize when the overlay becomes visible (in case HTML was injected late)
  if (overlay) {
    const observer = new MutationObserver(() => {
      const isHidden = overlay.classList.contains('hidden');
      if (!isHidden) initEnhancedSearch();
    });
    observer.observe(overlay, { attributes: true, attributeFilter: ['class'] });
  }
</script>
