---
import type { AffiliateProduct } from "../lib/products";
import { PRODUCTS } from "../lib/products";

const {
  categories = [],
  maxItems = 2,
  title = "Rekomendasi Produk Terkait",
  description = "Dipilih khusus sesuai topik artikel ini. Belanja via link ini bantu ibedes terus bikin konten.",
} = Astro.props as {
  categories?: string[];
  maxItems?: number;
  title?: string;
  description?: string;
};

const normalizedCategories = Array.from(
  new Set(
    (categories ?? [])
      .map((category) => category?.toLowerCase?.().trim())
      .filter((category): category is string => Boolean(category)),
  ),
);

const primaryMatches = normalizedCategories.length
  ? PRODUCTS.filter((product) => normalizedCategories.includes(product.category.toLowerCase()))
  : [];

const backupMatches = normalizedCategories.length
  ? PRODUCTS.filter((product) =>
      product.tags?.some((tag) => normalizedCategories.includes(tag.toLowerCase())),
    )
  : [];

const recommendations: AffiliateProduct[] = (primaryMatches.length ? primaryMatches : backupMatches).slice(0, maxItems);
const hasRecommendations = recommendations.length > 0;
const blockId = `affiliate-inline-${Math.random().toString(36).slice(2, 9)}`;
---

{hasRecommendations && (
  <section
    id={blockId}
    data-affiliate-inline
    class="not-prose my-8"
  >
    <div class="rounded-3xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-5 sm:p-6 lg:p-8 shadow-sm">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between mb-6">
        <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-emerald-600 dark:text-emerald-400">Link Affiliate</p>
        <div>
          <h3 class="text-xl font-semibold text-slate-900 dark:text-white">{title}</h3>
          <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">{description}</p>
        </div>
      </div>
      <div class="flex flex-col gap-3">
        {recommendations.map((product) => {
          const primaryLink = product.links[0];
          return (
            <article
              class="flex flex-row items-center gap-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50/70 dark:bg-slate-800/40 p-3 shadow-sm"
              data-category={product.category}
            >
              {product.image && (
                <img
                  src={product.image}
                  alt={product.imageAlt ?? product.title}
                  loading="lazy"
                  decoding="async"
                  class="h-16 w-16 flex-shrink-0 rounded-lg object-cover"
                />
              )}

              <div class="flex flex-1 flex-col gap-1">
                <h4 class="text-sm font-semibold text-slate-900 dark:text-white leading-snug">{product.title}</h4>
                <p class="text-xs text-slate-600 dark:text-slate-400 line-clamp-2">{product.description}</p>
              </div>

              {primaryLink && (
                <a
                  href={primaryLink.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-xs font-semibold text-emerald-700 dark:text-emerald-300 hover:text-emerald-500 dark:hover:text-emerald-200"
                  data-affiliate-link
                  data-product={product.slug}
                  data-label={`Inline - ${primaryLink.label}`}
                >
                  {primaryLink.label ?? "Cek"}
                </a>
              )}
            </article>
          );
        })}
      </div>
    </div>
  </section>
)}

{hasRecommendations && (
  <script is:inline>
    {`
      (() => {
        if (typeof window === 'undefined') return;
        const block = document.getElementById('${blockId}');
        if (!block) return;
        const articleBody = document.querySelector('[data-article-body]');
        if (!articleBody) return;
        const paragraphs = Array.from(articleBody.querySelectorAll('p')).filter(
          (p) => !p.closest('[data-affiliate-inline]'),
        );
        const fallbackAnchors = Array.from(
          articleBody.querySelectorAll('h2, h3, h4, h5, h6, ul, ol, hr'),
        ).filter((node) => !node.closest('[data-affiliate-inline]'));
        const anchors = paragraphs.length ? paragraphs : fallbackAnchors;
        if (!anchors.length) return;
        const targetIndex = Math.max(1, Math.ceil(anchors.length / 2) - 1);
        const target = anchors[targetIndex] ?? anchors[anchors.length - 1];
        if (target?.parentNode) {
          target.parentNode.insertBefore(block, target.nextSibling);
        }
      })();
    `}
  </script>
)}
