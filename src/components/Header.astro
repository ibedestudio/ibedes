---
import { GLOBAL } from "../lib/variables";
import Anchor from "./common/Anchor.astro";
import ThemeToggle from "./ThemeToggle.astro";
import CommandPalette from "./CommandPalette.astro";
---

<header
  class="zag-bg zag-border-b zag-transition sticky top-0 w-full z-10"
>
  <div
    class="zag-bg zag-transition sm:hidden relative z-50 py-4 px-4 flex items-center justify-between"
  >
    <button class="p-2" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="main-nav" data-nav-toggle>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="32"
        height="32"
        viewBox="0 0 512 512"
        class="zag-fill zag-transition"
      >
        <path d="M80 96h352v32H80zm0 144h352v32H80zm0 144h352v32H80z"></path>
      </svg>
    </button>
    <div class="flex items-center gap-2">
      <button
        type="button"
        class="p-2 rounded-full border border-black/20 dark:border-white/30 sm:hidden"
        aria-label="Buka pencarian global"
        data-command-toggle
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-6 h-6 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M15.5 14h-.79l-.28-.27A6 6 0 1 0 14 15.5l.27.28v.79l5 5 1.5-1.5-5-5zm-5.5 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"
            fill="currentColor"
          />
        </svg>
      </button>
    </div>
  </div>
  <!-- Backdrop for mobile menu -->
  <div
    class="fixed inset-0 bg-black/30 dark:bg-white/10 z-30 sm:hidden hidden"
    data-nav-backdrop
    aria-hidden="true"
  ></div>

  <nav
    class="zag-bg zag-border-b zag-transition fixed sm:relative inset-x-0 top-16 sm:top-0 h-auto sm:px-4 py-3 sm:py-4 max-w-4xl mx-auto sm:border-none z-40 hidden flex sm:flex mobile-nav-column"
    id="main-nav"
    role="navigation"
    aria-label="Main navigation"
    aria-hidden="true"
  >
    <div class="flex items-center justify-between w-full gap-3 px-4 sm:px-0">
      <div class="nav-scroll flex items-center gap-2 overflow-x-auto py-1 pr-2" data-nav-list>
        {Object.entries(GLOBAL.menu).map(([label, href]) => {
          const isHome = href === "/";
          const isActive = isHome ? Astro.url.pathname === "/" : (Astro.url.pathname === href || Astro.url.pathname.startsWith(href + "/"));
          return (
            <a
              href={href}
              class:list={[
                "px-3 py-1 rounded-full border text-[11px] uppercase tracking-[0.25em] whitespace-nowrap",
                "border-black/20 dark:border-white/30", 
                isActive ? "bg-black text-white dark:bg-white dark:text-black" : "bg-transparent zag-muted hover:text-current"
              ]}
              aria-current={isActive ? "page" : undefined}
            >{label}</a>
          );
        })}
      </div>
      <div class="flex gap-3 items-center sm:flex-shrink-0">
      {GLOBAL.githubProfile && (<Anchor url={GLOBAL.githubProfile} aria-label="Zaggonaut GitHub Repository">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          class="zag-fill zag-transition"
        >
          <path
            d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"
          ></path>
        </svg>
      </Anchor>)}
      
      <!-- Enhanced Search Button -->
      <button
        type="button"
        class="hidden sm:inline-flex items-center gap-2 border border-black/20 dark:border-white/30 rounded-full px-4 py-2 text-[10px] uppercase tracking-[0.35em]"
        data-command-toggle
        aria-label="Buka pencarian cerdas (Ctrl+K)"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="w-4 h-4 zag-fill zag-transition"
          aria-hidden="true"
        >
          <path
            d="M15.5 14h-.79l-.28-.27A6 6 0 1 0 14 15.5l.27.28v.79l5 5 1.5-1.5-5-5zm-5.5 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"
            fill="currentColor"
          />
        </svg>
        <span>Cari</span>
        <span class="inline-flex gap-1 items-center text-[9px] tracking-[0.25em]">
          <kbd>Ctrl</kbd>+<kbd>K</kbd>
        </span>
      </button>
      
      <ThemeToggle />
    </div>
  </nav>
  
  <!-- Simple Command Palette (original search) -->
  <CommandPalette />
</header>

<script>
// Elements
const navToggle = document.querySelector('[data-nav-toggle]');
const nav = document.getElementById('main-nav');
const backdrop = document.querySelector('[data-nav-backdrop]');
let isNavOpen = false;

const setAria = (open) => {
  if (navToggle) navToggle.setAttribute('aria-expanded', String(open));
  if (nav) nav.setAttribute('aria-hidden', String(!open));
  if (backdrop) backdrop.setAttribute('aria-hidden', String(!open));
};

const applyClasses = (open) => {
  if (!nav) return;
  const isMobile = window.matchMedia('(max-width: 640px)').matches;
  if (isMobile) {
    nav.classList.toggle('hidden', !open);
    nav.classList.toggle('flex', open);
    if (backdrop) {
      backdrop.classList.toggle('hidden', !open);
    }
    document.documentElement.style.overflow = open ? 'hidden' : '';
  } else {
    // On >= sm keep nav visible and reset state
    nav.classList.remove('hidden');
    nav.classList.add('flex');
    if (backdrop) backdrop.classList.add('hidden');
    document.documentElement.style.overflow = '';
    isNavOpen = false;
    setAria(false);
  }
};

const updateNavState = () => applyClasses(isNavOpen);

const closeNav = () => {
  isNavOpen = false;
  setAria(false);
  applyClasses(false);
};

const toggleNav = () => {
  isNavOpen = !isNavOpen;
  setAria(isNavOpen);
  applyClasses(isNavOpen);
};

// Event listeners
navToggle && navToggle.addEventListener('click', toggleNav);
backdrop && backdrop.addEventListener('click', closeNav);

// Close on `Esc`
window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && isNavOpen) closeNav();
});

// Close after clicking a menu link (mobile)
const navList = document.querySelector('[data-nav-list]');
navList && navList.addEventListener('click', (e) => {
  const t = e.target;
  if (t && t.closest('a')) closeNav();
});

// Initialize and respond to viewport changes
window.addEventListener('resize', updateNavState);
updateNavState();

// Hide scrollbars for nav-scroll container
const style = document.createElement('style');
style.textContent = `.nav-scroll{scrollbar-width:none}.nav-scroll::-webkit-scrollbar{display:none}`;
document.head.appendChild(style);

// Check for service worker readiness (no-op)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.ready.then((registration) => {
    console.log('Service Worker ready:', registration);
  });
}
</script>
