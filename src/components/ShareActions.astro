---
import { GLOBAL } from "../lib/variables";

export interface Props {
  title: string;
  url: string;
  class?: string;
}

const { title, url, class: className } = Astro.props;

const normalizeUrl = (rawUrl: string) => {
  if (!rawUrl) return GLOBAL.rootUrl;
  if (rawUrl.startsWith("http")) return rawUrl;
  if (rawUrl.startsWith("/")) return `${GLOBAL.rootUrl}${rawUrl}`;
  return `${GLOBAL.rootUrl}/${rawUrl}`;
};

const absoluteUrl = normalizeUrl(url);
const encodedUrl = encodeURIComponent(absoluteUrl);
const encodedTitle = encodeURIComponent(title);

const shareTargets = [
  {
    label: "WhatsApp",
    href: `https://wa.me/?text=${encodedTitle}%20${encodedUrl}`,
    aria: "Bagikan melalui WhatsApp",
    icon: "fa-brands fa-whatsapp",
    accent: "text-emerald-600",
  },
  {
    label: "X",
    href: `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`,
    aria: "Bagikan melalui X (Twitter)",
    icon: "fa-brands fa-x-twitter",
    accent: "text-zinc-900 dark:text-zinc-100",
  },
  {
    label: "LinkedIn",
    href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
    aria: "Bagikan melalui LinkedIn",
    icon: "fa-brands fa-linkedin-in",
    accent: "text-sky-700",
  },
  {
    label: "Facebook",
    href: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
    aria: "Bagikan melalui Facebook",
    icon: "fa-brands fa-facebook-f",
    accent: "text-blue-600",
  },
  {
    label: "Threads",
    href: `https://www.threads.net/intent/post?text=${encodedTitle}%20${encodedUrl}`,
    aria: "Bagikan melalui Threads",
    icon: "fa-brands fa-threads",
    accent: "text-zinc-900 dark:text-zinc-100",
  },
];

---

<section
  class:list={[
        "share-card rounded-3xl border-2 border-black/70 dark:border-white/60 bg-white/80 dark:bg-zinc-900/80 p-5 flex flex-col gap-5",
        className,
      ]}
  data-share-section
  data-share-url={absoluteUrl}
  data-share-title={title}
  data-site-name={GLOBAL.username}
>
  <div class="flex items-center justify-between gap-4">
    <div>
      <p class="font-display text-xs uppercase tracking-[0.35em] zag-muted">
        Bagikan
      </p>
      <p class="text-lg font-semibold">Sebarkan ke temanmu.</p>
    </div>
    <span class="share-card__badge" aria-hidden="true">
      <i class="fa-solid fa-share-nodes"></i>
    </span>
  </div>

  <div class="share-grid">
    {
      shareTargets.map((target) => (
        <a
          href={target.href}
          target="_blank"
          rel="noopener noreferrer"
          class="share-pill"
          aria-label={target.aria}
        >
          <span class:list={["share-pill__icon", target.accent]}>
            <i class={target.icon} aria-hidden="true"></i>
          </span>
          <span>{target.label}</span>
        </a>
      ))
    }
  </div>

  <div class="share-utilities">
    <button type="button" data-share-copy class="share-utility">
      <span aria-hidden="true"><i class="fa-regular fa-copy"></i></span>
      Salin Link
    </button>
    <button type="button" data-web-share class="share-utility">
      <span aria-hidden="true"><i class="fa-solid fa-up-right-from-square"></i></span>
      Share viaâ€¦
    </button>
    <button type="button" data-share-preview class="share-utility share-utility--accent">
      <span aria-hidden="true"><i class="fa-regular fa-image"></i></span>
      Preview Card
    </button>
  </div>

  <p
    data-copy-feedback
    class="text-xs font-mono uppercase tracking-[0.2em] text-emerald-700 dark:text-emerald-300 opacity-0 transition-opacity duration-300"
  >
    Link sudah tersalin!
  </p>

  <div class="share-preview" data-share-preview-panel hidden>
    <img
      data-share-preview-image
      alt="Social preview"
      class="share-preview__image"
    />
    <div class="share-preview__actions">
      <a
        data-share-preview-download
        href="#"
        class="share-preview__download"
        download="ibedes-preview.png"
      >
        Unduh PNG
      </a>
      <button type="button" data-share-preview-dismiss>Close</button>
    </div>
  </div>

  <script is:inline>
    (() => {
      if (typeof window === "undefined") return;
      const script = document.currentScript;
      const section = script?.closest?.("[data-share-section]");
      if (!section) return;
      const copyBtn = section.querySelector("[data-share-copy]");
      const feedback = section.querySelector("[data-copy-feedback]");
      const shareBtn = section.querySelector("[data-web-share]");
      const shareUrl = section.getAttribute("data-share-url") ?? window.location.href;
      const shareTitle = section.getAttribute("data-share-title") ?? document.title;
      const siteName = section.getAttribute("data-site-name") ?? "ibedes.xyz";
      const previewBtn = section.querySelector("[data-share-preview]");
      const previewPanel = section.querySelector("[data-share-preview-panel]");
      const previewImage = section.querySelector("[data-share-preview-image]");
      const previewDownload = section.querySelector("[data-share-preview-download]");
      const previewDismiss = section.querySelector("[data-share-preview-dismiss]");

      const showFeedback = () => {
        if (!feedback) return;
        feedback.setAttribute("data-visible", "true");
        feedback.style.opacity = "1";
        window.setTimeout(() => {
          feedback.style.opacity = "0";
          feedback.removeAttribute("data-visible");
        }, 2000);
      };

      copyBtn?.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(shareUrl);
          showFeedback();
        } catch (error) {
          console.error("Gagal menyalin tautan:", error);
        }
      });

      if (!("share" in navigator)) {
        shareBtn?.remove();
      } else {
        shareBtn?.addEventListener("click", async () => {
          try {
            await navigator.share({
              title: shareTitle,
              text: shareTitle,
              url: shareUrl,
            });
          } catch (error) {
            if (error?.name !== "AbortError") {
              console.error("Gagal membuka Web Share API:", error);
            }
          }
        });
      }

      const wrapText = (ctx, text, x, y, maxWidth, lineHeight) => {
        const words = text.split(" ");
        let line = "";
        let drawY = y;
        words.forEach((word, index) => {
          const testLine = `${line}${word} `;
          const metrics = ctx.measureText(testLine);
          if (metrics.width > maxWidth && index > 0) {
            ctx.fillText(line, x, drawY);
            line = `${word} `;
            drawY += lineHeight;
          } else {
            line = testLine;
          }
        });
        if (line) ctx.fillText(line.trim(), x, drawY);
        return drawY + lineHeight;
      };

      const generatePreview = () => {
        const canvas = document.createElement("canvas");
        canvas.width = 1200;
        canvas.height = 630;
        const ctx = canvas.getContext("2d");
        if (!ctx) return null;
        const gradient = ctx.createLinearGradient(0, 0, 1200, 630);
        gradient.addColorStop(0, "#0f172a");
        gradient.addColorStop(1, "#064e3b");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "rgba(255,255,255,0.15)";
        ctx.fillRect(60, 60, 1080, 510);

        ctx.fillStyle = "#ecfccb";
        ctx.font = "bold 60px 'IBM Plex Mono', monospace";
        ctx.textBaseline = "top";
        wrapText(ctx, shareTitle, 120, 150, 960, 70);

        ctx.fillStyle = "#d1fae5";
        ctx.font = "28px 'IBM Plex Mono', monospace";
        ctx.fillText(siteName, 120, 470);

        ctx.fillStyle = "#bbf7d0";
        ctx.font = "20px 'IBM Plex Mono', monospace";
        ctx.fillText(shareUrl.replace(/^https?:\/\//, ""), 120, 520);

        return canvas.toDataURL("image/png");
      };

      previewBtn?.addEventListener("click", () => {
        const dataUrl = generatePreview();
        if (!dataUrl || !previewImage || !previewPanel || !previewDownload) return;
        previewImage.src = dataUrl;
        previewPanel.hidden = false;
        previewDownload.href = dataUrl;
        previewDownload.download = `${siteName.toLowerCase().replace(/\s+/g, "-")}-preview.png`;
      });

      previewDismiss?.addEventListener("click", () => {
        if (previewPanel) {
          previewPanel.hidden = true;
        }
      });
    })();
  </script>
</section>

<style>
  .share-card {
    position: relative;
    overflow: hidden;
  }

  .share-card__badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 999px;
    border: 2px solid rgba(0, 0, 0, 0.6);
    background: rgba(255, 255, 255, 0.8);
    font-size: 1rem;
  }

  .share-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.75rem;
  }

  .share-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.55rem 0.9rem;
    border-radius: 999px;
    border: 2px solid rgba(0, 0, 0, 0.4);
    background: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
    font-weight: 600;
    transition: transform 150ms ease, border-color 150ms ease;
  }

  .share-pill:hover {
    transform: translateY(-2px);
    border-color: rgba(16, 185, 129, 0.8);
  }

  .share-pill__icon {
    width: 1.8rem;
    height: 1.8rem;
    border-radius: 0.8rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.04);
    font-size: 1rem;
  }

  .share-utilities {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .share-utility {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.5rem 0.9rem;
    border-radius: 0.9rem;
    border: 2px dashed rgba(0, 0, 0, 0.35);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    font-weight: 600;
    transition: transform 150ms ease, border-color 150ms ease, color 150ms ease;
  }

  .share-utility--accent {
    border-style: solid;
    border-color: rgba(52, 211, 153, 0.7);
    color: rgb(4, 120, 87);
  }

  .share-utility:hover {
    transform: translateY(-2px);
    border-color: rgba(16, 185, 129, 0.9);
  }

  :global(.dark) .share-pill {
    background: rgba(24, 24, 27, 0.8);
    border-color: rgba(255, 255, 255, 0.2);
    color: #f1f5f9;
  }

  :global(.dark) .share-pill__icon {
    background: rgba(255, 255, 255, 0.08);
  }

  :global(.dark) .share-card__badge {
    background: rgba(24, 24, 27, 0.9);
    border-color: rgba(255, 255, 255, 0.3);
  }

  :global(.dark) .share-utility {
    border-color: rgba(255, 255, 255, 0.2);
    color: #e4e4e7;
  }

  :global(.dark) .share-utility--accent {
    color: #6ee7b7;
  }

  @media (max-width: 640px) {
    .share-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
  }
</style>
