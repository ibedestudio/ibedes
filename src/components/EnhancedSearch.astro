---
// Enhanced Search Component with Filters
import { getSearchItems } from "../lib/search";

interface Props {
   isOpen: boolean;
}

const { isOpen } = Astro.props;

// Get search items for initial render and tag extraction
const searchItems = await getSearchItems();

// Extract all available tags
const allTags = [...new Set(searchItems.flatMap(item => item.tags || []))].sort();

// For client-side, we'll fetch fresh data from API but hydrate with SSR data first
const searchItemsJSON = JSON.stringify(searchItems);
---

<div class={`fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-16 ${isOpen ? '' : 'hidden'}`} data-enhanced-search aria-hidden={!isOpen}>
    <div class="command-panel w-full max-w-2xl max-h-[90vh] overflow-hidden">
      <!-- Search Header -->
      <div class="flex items-center justify-between mb-4">
        <h2 id="enhanced-search-title" class="text-xl font-bold zag-text font-display">Pencarian Cerdas</h2>
        <button
          type="button"
          data-enhanced-search-close
          class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors"
          aria-label="Tutup pencarian"
        >
          <i class="fa-solid fa-xmark w-5 h-5"></i>
        </button>
      </div>

      <!-- Search Input -->
      <div class="relative mb-4">
        <input
          type="text"
          placeholder="Cari artikel, layanan, atau proyek..."
          class="command-panel__input"
          id="enhanced-search-input"
        />
        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
          <i class="fa-solid fa-magnifying-glass w-5 h-5"></i>
        </div>
      </div>

      <!-- Search Results -->

      <!-- Search Results -->
      <div class="command-panel__results" id="enhanced-search-results">
        <div class="space-y-2" id="search-results-list">
          <!-- Results will be loaded dynamically -->
        </div>
        <div id="search-results-status" class="text-center text-sm text-gray-500 dark:text-gray-400 py-3 hidden"></div>
      </div>

      <!-- Search Shortcuts -->
      <div class="command-shortcuts mt-4 text-center">
        <p class="mb-2">Keyboard Shortcuts:</p>
        <div class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 text-xs">
          <span><kbd>↑↓</kbd> Navigate</span>
          <span><kbd>Enter</kbd> Open</span>
          <span><kbd>Esc</kbd> Close</span>
          <span><kbd>Ctrl+K</kbd> Quick Search</span>
        </div>
      </div>
    </div>
  </div>

<script define:vars={{ searchItemsJSON }}>
   // Global state
   let searchItems = [];
   let searchQuery = '';
   let isInitialized = false;
   let isLoading = false;
   let hasError = false;

   // Fetch search items from API
   async function loadSearchItems() {
     setStatus('Memuat data pencarian…', 'loading');
     isLoading = true;
     hasError = false;
     try {
       const response = await fetch('/api/search.json');
       if (response.ok) {
         searchItems = await response.json();
         filterAndSortResults();
         clearStatus();
       } else {
         console.error('Failed to load search items');
         setStatus('Gagal memuat data pencarian', 'error');
         hasError = true;
       }
     } catch (error) {
       console.error('Error loading search items:', error);
       setStatus('Terjadi kesalahan saat memuat hasil', 'error');
       hasError = true;
     }

     isLoading = false;
   }

  // Enhanced search functionality
  function handleEnhancedSearch(query) {
    searchQuery = query;
    filterAndSortResults();
  }


  function navigateToResult(url) {
    window.location.href = url;
  }

  // Filter and sort results
  function filterAndSortResults() {
    let results = searchItems || [];
    const query = searchQuery.toLowerCase();

    // Filter by search query
    if (query) {
      results = results.filter(item => {
        const title = (item.title || '').toLowerCase();
        const desc = (item.description || '').toLowerCase();
        const tags = Array.isArray(item.tags) ? item.tags : [];
        return (
          title.includes(query) ||
          desc.includes(query) ||
          tags.some(tag => (tag || '').toLowerCase().includes(query))
        );
      });
    }

    updateSearchResults(results);
  }

  // Update search results display
  function updateSearchResults(results) {
    const container = document.getElementById('search-results-list');
    if (!container) return;

    container.replaceChildren();
    if (isLoading) {
      return;
    }
    if (hasError) {
      return;
    }
    if (results.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'command-empty';
      const emptyText = document.createElement('p');
      emptyText.textContent = 'Tidak ada hasil ditemukan';
      empty.appendChild(emptyText);
      container.appendChild(empty);
      return;
    }

    // Group results by type
    const groupedResults = results.reduce((acc, item) => {
      const type = item.type || 'unknown';
      if (!acc[type]) {
        acc[type] = [];
      }
      acc[type].push(item);
      return acc;
    }, {});

    const categoryOrder = ['article', 'project', 'service'];
    const categoryLabels = {
        article: '<i class="fa-solid fa-newspaper w-4 h-4 mr-2"></i> Artikel',
        project: '<i class="fa-solid fa-rocket-launch w-4 h-4 mr-2"></i> Proyek',
        service: '<i class="fa-solid fa-wrench w-4 h-4 mr-2"></i> Layanan'
    };

    categoryOrder.forEach(category => {
      const items = groupedResults[category];
      if (!items || items.length === 0) return;

      // Create group header
      const groupHeader = document.createElement('div');
      groupHeader.className = 'flex items-center px-2 py-1 mt-4 text-xs font-semibold tracking-wider uppercase text-gray-400 dark:text-gray-500';
      groupHeader.innerHTML = categoryLabels[category];
      container.appendChild(groupHeader);

      items.forEach(item => {
        const commandItem = document.createElement('div');
        commandItem.className = 'command-item rounded-lg p-3 zag-transition hover:bg-zinc-100 dark:hover:bg-zinc-800';
        commandItem.dataset.type = item.type;

        const layout = document.createElement('div');
        layout.className = 'flex items-start justify-between';
        commandItem.appendChild(layout);

        const textColumn = document.createElement('div');
        textColumn.className = 'flex-1';
        layout.appendChild(textColumn);

        const title = document.createElement('div');
        title.className = 'command-item__title font-medium zag-text mb-1';
        title.textContent = item.title || '';
        textColumn.appendChild(title);

        if (item.description) {
            const description = document.createElement('p');
            description.className = 'text-xs zag-muted';
            description.textContent = item.description;
            textColumn.appendChild(description);
        }

        const actionButton = document.createElement('button');
        actionButton.type = 'button';
        actionButton.className = 'px-3 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors ml-4';
        actionButton.textContent = 'Buka';
        actionButton.addEventListener('click', event => {
          event.stopPropagation();
          navigateToResult(item.url);
        });
        layout.appendChild(actionButton);

        commandItem.addEventListener('click', () => {
          navigateToResult(item.url);
        });

        container.appendChild(commandItem);
      });
    });
  }

  const overlay = document.querySelector('[data-enhanced-search]');

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    const searchContainer = overlay;
    if (!searchContainer || searchContainer.classList.contains('hidden')) return;
    
    const results = document.querySelectorAll('#search-results-list .command-item');
    let currentIndex = -1;
    
    // Find currently selected item
    results.forEach((result, index) => {
      if (result.getAttribute('data-active') === 'true') {
        currentIndex = index;
      }
    });

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        if (currentIndex < results.length - 1) {
          if (results[currentIndex]) results[currentIndex].removeAttribute('data-active');
          if (results[currentIndex + 1]) results[currentIndex + 1].setAttribute('data-active', 'true');
        }
        break;
      case 'ArrowUp':
        e.preventDefault();
        if (currentIndex > 0) {
          if (results[currentIndex]) results[currentIndex].removeAttribute('data-active');
          if (results[currentIndex - 1]) results[currentIndex - 1].setAttribute('data-active', 'true');
        }
        break;
      case 'Enter':
        if (currentIndex >= 0 && results[currentIndex]) {
          results[currentIndex].click();
        }
        break;
      case 'Escape':
        searchContainer.classList.add('hidden');
        searchContainer.setAttribute('aria-hidden', 'true');
        break;
    }
  });

  const openOverlay = () => {
    if (!overlay) return;
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    initEnhancedSearch();
    const input = document.getElementById('enhanced-search-input');
    if (input) input.focus();
  };

  const closeOverlay = () => {
    if (!overlay) return;
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden', 'true');
  };

  const toggleOverlay = () => {
    if (!overlay) return;
    const isHidden = overlay.classList.contains('hidden');
    if (isHidden) {
      openOverlay();
    } else {
      closeOverlay();
    }
  };

  // Toggle buttons
  const toggleButtons = Array.from(document.querySelectorAll('[data-enhanced-search-toggle]'));
  toggleButtons.forEach((btn) => btn.addEventListener('click', (e) => {
    e.preventDefault();
    toggleOverlay();
  }));

  // Close when clicking backdrop
  overlay?.addEventListener('click', (event) => {
    if (event.target === overlay) {
      closeOverlay();
    }
  });

  // Global keyboard shortcut
  document.addEventListener('keydown', (event) => {
    const metaKey = event.metaKey || event.ctrlKey;
    if (metaKey && event.key.toLowerCase() === 'k') {
      event.preventDefault();
      openOverlay();
    }
    if (event.key === 'Escape' && overlay && !overlay.classList.contains('hidden')) {
      closeOverlay();
    }
  });

  // Initialize component (idempotent)
  function initEnhancedSearch() {
    if (isInitialized) return;
    isInitialized = true;

    // Hydrate with initial SSR data before fetching fresh data
    try {
      const initialItems = JSON.parse(searchItemsJSON);
      if (Array.isArray(initialItems) && initialItems.length > 0) {
        searchItems = initialItems;
        filterAndSortResults();
      }
    } catch (error) {
      console.error('Failed to hydrate search items', error);
    }

    // Add input event listener for search
    const input = document.getElementById('enhanced-search-input');
    if (input) {
      input.addEventListener('input', function(e) {
        // Plain JS for browser compatibility
        // @ts-ignore - target is HTMLInputElement
        handleEnhancedSearch(e.target && e.target.value ? e.target.value : '');
      });

      // Focus search input when panel is first shown
      requestAnimationFrame(() => {
        input.focus();
      });
    }


    // Load search items from API immediately
    loadSearchItems();
  }

  // Run init now if DOM already loaded; otherwise wait for DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEnhancedSearch);
  } else {
    initEnhancedSearch();
  }

  // Also initialize when the overlay becomes visible (in case HTML was injected late)
  if (overlay) {
    const observer = new MutationObserver(() => {
      const isHidden = overlay.classList.contains('hidden');
      if (!isHidden) initEnhancedSearch();
    });
    observer.observe(overlay, { attributes: true, attributeFilter: ['class'] });
  }
</script>
